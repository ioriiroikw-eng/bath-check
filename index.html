<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>ãƒ•ãƒ­ãƒã‚¤ãƒƒã‚¿ï¼Ÿï½œå…¥æµ´ç¿’æ…£ã‚¢ãƒ—ãƒª</title>
    <meta name="application-name" content="ãƒ•ãƒ­ãƒã‚¤ãƒƒã‚¿ï¼Ÿ">
    <meta name="apple-mobile-web-app-title" content="ãƒ•ãƒ­ãƒã‚¤ãƒƒã‚¿ï¼Ÿ">
    <meta name="description" content="ã€Œãƒ•ãƒ­ãƒã‚¤ãƒƒã‚¿ï¼Ÿã€ã¯ã€æ¯æ—¥ã®å…¥æµ´ã‚’æ¥½ã—ãç¿’æ…£åŒ–ã™ã‚‹ç„¡æ–™Webã‚¢ãƒ—ãƒªã§ã™ã€‚å¤©æ°—é€£å‹•HPã€æœ¬æ ¼ãŠé¢¨å‘‚å ã„ã§æ¥½ã—ãæ¸…æ½”åº¦ã‚’ã‚­ãƒ¼ãƒ—ã—ã‚ˆã†ï¼">
    <meta name="keywords" content="ãŠé¢¨å‘‚,è¨˜éŒ²,å…¥æµ´å‰¤,å¥åº·,ç¿’æ…£åŒ–,ã‚¢ãƒ—ãƒª,ã‚µã‚¦ãƒŠ,å…¥æµ´,ãƒ•ãƒ­ãƒã‚¤ãƒƒã‚¿,å ã„">
    <meta name="robots" content="index, follow">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#fdf2f8">

    <link rel="icon" href="https://ioriiroikw-eng.github.io/bath-check/icon.png">
    <link rel="apple-touch-icon" href="https://ioriiroikw-eng.github.io/bath-check/icon.png">
    
    <meta property="og:title" content="ãƒ•ãƒ­ãƒã‚¤ãƒƒã‚¿ï¼Ÿï½œå…¥æµ´ç¿’æ…£ã‚¢ãƒ—ãƒª">
    <meta property="og:description" content="ç¾åœ¨ã®ãŠé¢¨å‘‚çŠ¶æ³ã‚’è¨˜éŒ²ä¸­... ç§ã®æ¸…æ½”åº¦ã¯ï¼Ÿæ¥½ã—ãå…¥æµ´ç¿’æ…£ã‚’ã¤ã‘ã‚ˆã†ï¼ #ãƒ•ãƒ­ãƒã‚¤ãƒƒã‚¿">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ioriiroikw-eng.github.io/bath-check/">
    <meta property="og:image" content="https://ioriiroikw-eng.github.io/bath-check/icon.png">
    <meta property="og:site_name" content="ãƒ•ãƒ­ãƒã‚¤ãƒƒã‚¿ï¼Ÿ">
    <meta property="og:locale" content="ja_JP">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="ãƒ•ãƒ­ãƒã‚¤ãƒƒã‚¿ï¼Ÿï½œå…¥æµ´ç¿’æ…£ã‚¢ãƒ—ãƒª">
    <meta name="twitter:description" content="ç¾åœ¨ã®ãŠé¢¨å‘‚çŠ¶æ³ã‚’è¨˜éŒ²ä¸­... æ¸…æ½”åº¦ã‚’ã‚­ãƒ¼ãƒ—ã—ã¦ã‚­ãƒ£ãƒ©ã‚’è‚²ã¦ã‚ˆã†ï¼">
    <meta name="twitter:image" content="https://ioriiroikw-eng.github.io/bath-check/icon.png">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Yomogi&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: #fdf2f8; overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; background-image: radial-gradient(#fbcfe8 20%, transparent 20%), radial-gradient(#fbcfe8 20%, transparent 20%); background-position: 0 0, 10px 10px; background-size: 20px 20px; user-select: none; overflow-x: hidden; }
        .font-pop { font-family: 'Mochiy Pop One', sans-serif; }
        .font-hand { font-family: 'Yomogi', cursive; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .purupuru { animation: purupuru 2s infinite; }
        @keyframes purupuru { 0% { transform: scale(1, 1); } 10% { transform: scale(1.02, 0.98); } 40% { transform: scale(0.98, 1.02); } 50% { transform: scale(1, 1); } }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 3px solid rgba(255, 255, 255, 1); box-shadow: 0 8px 32px 0 rgba(236, 72, 153, 0.15); border-radius: 32px; }
        .meter-track { background: #f3f4f6; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .meter-fill { background: linear-gradient(90deg, #f9a8d4, #ec4899, #fbbf24); box-shadow: 0 2px 4px rgba(236, 72, 153, 0.3); }
        .meter-icon { filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); transition: left 0.5s ease-out; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .calendar-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 4px; font-size: 12px; position: relative; background: rgba(255,255,255,0.5); border-radius: 8px; }
        @keyframes stampIn { 0% { opacity: 0; transform: scale(2) rotate(0deg); } 50% { opacity: 1; transform: scale(0.8); } 70% { transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
        .stamp-animate { animation: stampIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; display: inline-block; line-height: 1; }
        .modal-enter { animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalPop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .float-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; overflow: hidden; }
        .float-item { position: absolute; opacity: 0.3; animation: floatUp linear infinite; }
        @keyframes floatUp { 0% { transform: translateY(100vh) rotate(0deg); opacity: 0; } 100% { transform: translateY(-100px) rotate(360deg); opacity: 0; } }
        .slide-up { animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .card-inner.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card-front { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); border: 4px solid white; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        .card-back { background: white; transform: rotateY(180deg); border: 4px solid #fce7f3; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .star-rating { color: #fbbf24; }
        .star-rating-gray { color: #e5e7eb; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- è¨­å®šãƒ»å®šæ•° ---
        const BASE_RATE_PER_HOUR = 2.5; 
        const STORAGE_KEY_HP = 'hq_hp';
        const STORAGE_KEY_LAST_BATH = 'hq_last_bath';
        const STORAGE_KEY_DAMAGE = 'hq_damage';
        const STORAGE_KEY_LOGS = 'hq_logs';
        const STORAGE_KEY_HISTORY = 'hq_history';
        const STORAGE_KEY_WEATHER = 'hq_weather_v1'; 

        // --- éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ« ---
        const SE_POP_URL = "./audio/se_pop.mp3";   
        const SE_KIRA_URL = "./audio/se_kira.mp3"; 
        const BGM_URL = "./audio/bgm.mp3"; 
        
        // --- å ã„ãƒ‡ãƒ¼ã‚¿ ---
        const FORTUNE_RANKS = [
            { id: 'kamiyu',   name: 'ç¥æ¹¯',   read:'ã‹ã¿ã‚†',   prob: 0.05, minStar: 4, color: 'text-purple-600', bg: 'bg-purple-50' },
            { id: 'appare',   name: 'å¤©æ™´',   read:'ã‚ã£ã±ã‚Œ', prob: 0.15, minStar: 4, color: 'text-pink-500',   bg: 'bg-pink-50' },
            { id: 'gokuraku', name: 'æ¥µæ¥½',   read:'ã”ãã‚‰ã', prob: 0.20, minStar: 3, color: 'text-orange-500', bg: 'bg-orange-50' },
            { id: 'yoiyu',    name: 'è‰¯æ¹¯',   read:'ã‚ˆã„ã‚†',   prob: 0.25, minStar: 3, color: 'text-blue-500',   bg: 'bg-blue-50' },
            { id: 'totonoyu', name: 'æ•´æ¹¯',   read:'ã¨ã¨ã®ã‚†', prob: 0.15, minStar: 2, color: 'text-green-500',  bg: 'bg-green-50' },
            { id: 'nurumayu', name: 'å¾®æ¸©',   read:'ã¬ã‚‹ã¾ã‚†', prob: 0.10, minStar: 2, color: 'text-teal-600',   bg: 'bg-teal-50' },
            { id: 'haran',    name: 'æ³¢ä¹±',   read:'ã¯ã‚‰ã‚“',   prob: 0.10, minStar: 1, color: 'text-gray-500',   bg: 'bg-gray-100' },
        ];

        const FORTUNE_MESSAGES = {
            kamiyu: [{ title: "å¥‡è·¡ã®æµ„åŒ–", desc: "å¤ã„è§’è³ªã¨å…±ã«éå»ã®å„ã¾ã§æ´—ã„æµã•ã‚Œã¾ã—ãŸã€‚ä»Šæ—¥ã®ã‚ãªãŸã¯ç„¡æ•µã®ã‚ªãƒ¼ãƒ©ã‚’æ”¾ã£ã¦ã„ã¾ã™ã€‚" }, { title: "é¸ã°ã‚Œã—è€…", desc: "æ¹¯ã®ç¥ã«æ„›ã•ã‚Œã¦ã„ã¾ã™ã€‚å…¥æµ´ã«ã‚ˆã£ã¦æ½œåœ¨èƒ½åŠ›ãŒè§£æ”¾ã•ã‚Œã€ã‚¢ã‚¤ãƒ‡ã‚¢ãŒç„¡é™ã«æ¹§ãå‡ºã‚‹ã§ã—ã‚‡ã†ã€‚" }],
            appare: [{ title: "æœ€é«˜ã«æ•´ã†æ—¥", desc: "å¿ƒèº«ã®ãƒãƒ©ãƒ³ã‚¹ãŒå®Œç’§ã«æ•´ã„ã¾ã—ãŸã€‚ã“ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’ä½¿ãˆã°ã€ã©ã‚“ãªå›°é›£ã‚‚ä¹—ã‚Šè¶Šãˆã‚‰ã‚Œã¾ã™ã€‚" }, { title: "è¦–ç•Œè‰¯å¥½", desc: "æ¹¯æ°—ã®ã‚ˆã†ã«æ‚©ã¿ãŒæ™´ã‚Œã¦ã„ãã¾ã™ã€‚ç›´æ„ŸãŒå†´ãˆæ¸¡ã‚Šã€ç´ æ™´ã‚‰ã—ã„æ±ºæ–­ãŒã§ãã‚‹æ—¥ã§ã™ã€‚" }],
            gokuraku: [{ title: "ç™’ã‚„ã—ã®æ³¢å‹•", desc: "èŠ¯ã¾ã§æ¸©ã¾ã‚Šã€æ·±ã„ãƒªãƒ©ãƒƒã‚¯ã‚¹çŠ¶æ…‹ã§ã™ã€‚äººã«ã‚‚å„ªã—ããªã‚Œã‚‹ã®ã§ã€å¯¾äººé‹ãŒä¸Šæ˜‡ã™ã‚‹äºˆæ„Ÿã€‚" }, { title: "æ¥µä¸Šã®ä¼‘æ¯", desc: "ã¾ã‚‹ã§æ¸©æ³‰æ—…è¡Œã«æ¥ãŸã‹ã®ã‚ˆã†ãªé–‹æ”¾æ„Ÿã€‚ä»Šæ—¥é ‘å¼µã£ãŸè‡ªåˆ†ã‚’ã€èª°ã‚ˆã‚Šã‚‚è¤’ã‚ã¦ã‚ã’ã¦ãã ã•ã„ã€‚" }],
            yoiyu: [{ title: "å®‰å®šã®æ¸©ã‚‚ã‚Š", desc: "ã„ã¤ã‚‚ã®ãŠé¢¨å‘‚ãŒã€ä¸€ç•ªã®å¹¸ã›ã€‚æ´¾æ‰‹ã•ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ç¢ºå®Ÿãªå¹¸ç¦ãŒã‚ãªãŸã‚’åŒ…ã‚“ã§ã„ã¾ã™ã€‚" }, { title: "ç¨‹ã‚ˆã„æ¹¯åŠ æ¸›", desc: "ç„¡ç†ãªãéã”ã›ã‚‹è‰¯ã„æ—¥ã§ã™ã€‚ã¬ã‚‹ã‚ã®ãŠæ¹¯ã«ã‚†ã£ãã‚Šæµ¸ã‹ã‚‹ã“ã¨ã§ã€é‹æ°—ãŒå®‰å®šã—ã¾ã™ã€‚" }],
            totonoyu: [{ title: "ãƒªã‚»ãƒƒãƒˆã®æ™‚", desc: "å°‘ã—ä¹±ã‚Œã¦ã„ãŸãƒªã‚ºãƒ ãŒæˆ»ã‚Šã¾ã—ãŸã€‚æ˜æ—¥ã«å‘ã‘ã¦ã®æº–å‚™ã¯ä¸‡ç«¯ã€‚æ—©ã‚ã«å¯ã‚‹ã¨ã•ã‚‰ã«å‰ã€‚" }, { title: "åŸºæœ¬ã«å¿ å®Ÿ", desc: "ä¸å¯§ã«ä½“ã‚’æ´—ã†ã“ã¨ã§é‹ãŒé–‹ã‘ã¾ã™ã€‚åŸºæœ¬ã‚’å¤§åˆ‡ã«ã™ã‚‹ã“ã¨ã§ã€ç‰©äº‹ãŒã‚¹ãƒ ãƒ¼ã‚ºã«é€²ã‚€ã§ã—ã‚‡ã†ã€‚" }],
            nurumayu: [{ title: "ã‚ã¨ä¸€æ­©", desc: "å°‘ã—é•·æ¹¯ã—ã™ããŸã‹ã‚‚ï¼Ÿæ°´åˆ†è£œçµ¦ã‚’ã—ã£ã‹ã‚Šã—ã¦ã€ãƒ€ãƒ©ãƒ€ãƒ©ã—ã™ããªã„ã‚ˆã†ã«æ°—ã‚’å¼•ãç· ã‚ã¦ã€‚" }, { title: "ç¾çŠ¶ç¶­æŒ", desc: "è‰¯ãã‚‚æ‚ªãã‚‚å¤‰åŒ–ã®ãªã„æ—¥ã€‚ã¬ã‚‹ã¾æ¹¯ã«æµ¸ã‹ã‚‹ã‚ˆã†ã«ã€ä»Šã®ç’°å¢ƒã«ç”˜ãˆã™ããªã„ã‚ˆã†æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚" }],
            haran: [{ title: "æ¹¯å†·ã‚æ³¨æ„å ±", desc: "å¿ƒãŒæ€¥ã„ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿã‚·ãƒ£ãƒ¯ãƒ¼ã ã‘ã§æ¸ˆã¾ã›ã‚‹ã¨é‹æ°—ãŒé€ƒã’ã¾ã™ã€‚5åˆ†ã§ã‚‚æ¹¯èˆ¹ã«æµ¸ã‹ã£ã¦å›é¿ã‚’ã€‚" }, { title: "è¦æµ„åŒ–", desc: "é‚ªæ°—ãŒæºœã¾ã£ã¦ã„ã¾ã™ã€‚ãŠé¢¨å‘‚æƒé™¤ã‚’å…¥å¿µã«è¡Œã„ã€æ¸…ã‚ã‚‹ã“ã¨ã§é‹æ°—ã‚’å–ã‚Šæˆ»ã›ã‚‹ã§ã—ã‚‡ã†ã€‚" }]
        };

        const FORTUNE_ACTIONS = ["ãŠæ°—ã«å…¥ã‚Šã®éŸ³æ¥½ã‚’ã‹ã‘ã¦30åˆ†æµ¸ã‹ã‚‹", "ç‚­é…¸ç³»ã®å…¥æµ´å‰¤ã‚’å…¥ã‚Œã¦æ·±å‘¼å¸", "æ¹¯èˆ¹ã®ä¸­ã§è¶³é¦–ã‚’10å›å›ã™", "ç›®ã‚’é–‰ã˜ã¦1åˆ†é–“ç„¡å¿ƒã«ãªã‚‹", "ä¸ŠãŒã£ãŸå¾Œã«å¸¸æ¸©ã®æ°´ã‚’é£²ã‚€", "æ–°ã—ã„ã‚¹ãƒãƒ³ã‚¸ã‚’ãŠã‚ã™", "ã‚·ãƒ£ãƒ¯ãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’ãƒ”ã‚«ãƒ”ã‚«ã«ç£¨ã", "ãŠé¢¨å‘‚ä¸ŠãŒã‚Šã«ã‚¹ãƒˆãƒ¬ãƒƒãƒã‚’ã™ã‚‹", "æŸ‘æ©˜ç³»ã®é¦™ã‚Šã‚’å—…ã", "æµ´å®¤ã®é¡ã‚’æ›‡ã‚Šãªãç£¨ã", "ãƒ˜ã‚¢ãƒ‘ãƒƒã‚¯ã‚’ã—ã¦5åˆ†å¾…ã¤", "è¶³ã®æŒ‡ã‚’ä¸€æœ¬ãšã¤ãƒãƒƒã‚µãƒ¼ã‚¸", "æ¹¯èˆ¹ã§ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¨3å›å”±ãˆã‚‹", "ãƒã‚¹ã‚½ãƒ«ãƒˆã§ç™ºæ±—ã‚’ä¿ƒã™", "ãŠé¢¨å‘‚ä¸ŠãŒã‚Šã«ä¿æ¹¿ã‚’å¾¹åº•ã™ã‚‹", "æ’æ°´æºã‚’æƒé™¤ã—ã¦é‹æ°—ã‚’æµã™", "å†·æ°´ã‚’è¶³ã«ã‹ã‘ã¦å¼•ãç· ã‚ã‚‹", "ã‚­ãƒ£ãƒ³ãƒ‰ãƒ«ï¼ˆãªã‘ã‚Œã°ç…§æ˜OFFï¼‰ã§ç‘æƒ³", "ã‚¢ãƒ’ãƒ«ã®ãŠã‚‚ã¡ã‚ƒã‚’æµ®ã‹ã¹ã¦éŠã¶", "é˜²æ°´ã‚¹ãƒãƒ›ã‚±ãƒ¼ã‚¹ã§å‹•ç”»ã‚’è¦‹ã‚‹", "å¤§ããªå£°ã§æ­Œã†ï¼ˆè¿‘æ‰€è¿·æƒ‘æ³¨æ„ï¼‰", "ãƒœãƒ‡ã‚£ã‚¹ã‚¯ãƒ©ãƒ–ã§å…¨èº«ç£¨ã", "é ­çš®ãƒãƒƒã‚µãƒ¼ã‚¸ã‚’å…¥å¿µã«ã™ã‚‹", "æ¹¯èˆ¹ã®ä¸­ã§ã‚°ãƒ¼ãƒãƒ§ã‚­ãƒ‘ãƒ¼é‹å‹•", "ä¸€ç•ªé¢¨å‘‚ã‚’ç‹™ã†", "å…¥æµ´å‰¤ã‚’æ··ãœã¦ã‚ªãƒªã‚¸ãƒŠãƒ«ã®è‰²ã‚’ä½œã‚‹", "ãŠé¢¨å‘‚ä¸ŠãŒã‚Šã«ãƒ•ãƒ«ãƒ¼ãƒ„ç‰›ä¹³ã‚’é£²ã‚€", "ãƒã‚¹ã‚¿ã‚ªãƒ«ã‚’ãµã‹ãµã‹ã®ç‰©ã«å¤‰ãˆã‚‹", "ãŠé¢¨å‘‚ä¸ŠãŒã‚Šã«çª“ã‚’é–‹ã‘ã¦æ›æ°—", "æ¹¯èˆ¹ã§æ·±å‘¼å¸ã—ã¦æ‚ªã„æ°—ã‚’åã"];

        const generateFortune = () => {
            const rand = Math.random();
            let cumulativeProb = 0;
            let selectedRank = FORTUNE_RANKS[FORTUNE_RANKS.length - 1];
            for (const rank of FORTUNE_RANKS) { cumulativeProb += rank.prob; if (rand < cumulativeProb) { selectedRank = rank; break; } }
            const messages = FORTUNE_MESSAGES[selectedRank.id];
            const message = messages[Math.floor(Math.random() * messages.length)];
            const getStar = (min) => Math.min(5, Math.max(1, min + Math.floor(Math.random() * 3)));
            return { rank: selectedRank.name, read: selectedRank.read, title: message.title, desc: message.desc, color: selectedRank.color, bg: selectedRank.bg, love: getStar(selectedRank.minStar - 1), money: getStar(selectedRank.minStar - 1), health: getStar(selectedRank.minStar), action: FORTUNE_ACTIONS[Math.floor(Math.random() * FORTUNE_ACTIONS.length)] };
        };

        const getLocalDateStr = (date) => { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };

        // --- ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
        const Icon = ({ path, className, size = 24, onClick }) => ( <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg> );
        const Icons = {
            Bath: (p) => <Icon {...p} path={<><path d="M9 6 6.5 3.5a1.5 1.5 0 0 0-1-1.5C3.81 2 2.5 3.31 2.5 5.5c0 1.56 1.15 2.1 1.8 2.2"/><path d="M21 10c0-1.66-1.34-3-3-3-1.12 0-2.1.58-2.6 1.5L14 10"/><path d="M7 10h14L19.5 21h-11Z"/><path d="M7 10v4"/></>} />,
            Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
            Calendar: (p) => <Icon {...p} path={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>} />,
            X: (p) => <Icon {...p} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            ChevronLeft: (p) => <Icon {...p} path={<><path d="m15 18-6-6 6-6"/></>} />,
            ChevronRight: (p) => <Icon {...p} path={<><path d="m9 18 6-6-6-6"/></>} />,
            Camera: (p) => <Icon {...p} path={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />,
            Share: (p) => <Icon {...p} path={<><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></>} />,
            Alert: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />,
            IosShare: (p) => <Icon {...p} path={<><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></>} />,
            Book: (p) => <Icon {...p} path={<><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></>} />,
            Cloud: (p) => <Icon {...p} path={<><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M17.5 19h.5a4 4 0 0 0 1.5-7.75"/><path d="M6.5 19h-.5a4 4 0 0 1-1.5-7.75"/><path d="M16.5 10A5 5 0 0 0 7.5 10"/></>} />,
            Sun: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></>} />,
            Help: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />,
            Star: (p) => <Icon {...p} path={<><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></>} />,
            Music: (p) => <Icon {...p} path={<><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></>} />,
            XLogo: (p) => <Icon {...p} path={<path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />} />,
        };

        const InAppBrowserWarning = ({ onClose }) => ( <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6 modal-enter"> <div className="bg-white rounded-3xl p-6 w-full max-w-sm text-center relative border-4 border-pink-400"> <div className="text-pink-500 mb-2 flex justify-center"><Icons.Alert size={48} /></div> <h2 className="text-xl font-black text-gray-800 mb-2 font-pop">âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¡ã‚ƒã†ã‹ã‚‚ï¼</h2> <p className="text-sm text-gray-600 mb-4 font-bold">ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶(LINEãªã©)ã§ã¯å±¥æ­´ãŒä¿å­˜ã•ã‚Œã¾ã›ã‚“ğŸ’¦</p> <div className="bg-gray-100 p-4 rounded-xl text-left mb-4 text-sm text-gray-700"> <p className="mb-2 font-bold">ğŸ‘‡ Safari/Chromeã§é–‹ã„ã¦ã­ï¼</p> <ol className="list-decimal list-inside space-y-1"> <li>å³ä¸Šã® <span className="font-bold bg-white px-1 rounded border">ï¸™</span> ã‚„ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™</li> <li><span className="font-bold text-blue-600">ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã€</span> ã‚’é¸ã¶</li> </ol> </div> <button onClick={onClose} className="text-xs text-gray-400 underline p-2">åˆ†ã‹ã£ãŸã‘ã©ã“ã®ã¾ã¾ä½¿ã†</button> </div> </div> );
        
        const InstallGuide = ({ onClose }) => { const isIOS = /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase()); return ( <div className="fixed bottom-0 left-0 right-0 p-4 z-50 slide-up pb-safe"> <div className="bg-gray-800/95 backdrop-blur text-white rounded-2xl p-4 shadow-2xl relative border border-pink-400"> <button onClick={onClose} className="absolute top-2 right-2 text-gray-400 p-2"><Icons.X size={18} /></button> <div className="flex items-start gap-4"> <div className="bg-pink-500 p-3 rounded-xl shrink-0"><Icons.Download size={24} /></div> <div> <h3 className="font-bold text-sm mb-1 font-pop">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã‚ˆã†ï¼</h3> <p className="text-xs text-gray-300 mb-2">ã‚¢ãƒ—ãƒªã¿ãŸã„ã«ä½¿ãˆã¦ã€å…¨ç”»é¢ã§è¦‹ã‚„ã™ããªã‚‹ã‚ˆâœ¨</p> <div className="text-xs font-bold text-pink-300 flex items-center gap-1 flex-wrap"> {isIOS ? <><span className="bg-gray-600 px-1 rounded inline-flex"><Icons.IosShare size={12}/></span> ã‹ã‚‰ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</> : <>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ <span className="bg-gray-600 px-1 rounded text-[10px]">ï¸™</span> ã‹ã‚‰ã€Œã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€</>} </div> </div> </div> </div> </div> ); };
        
        const WelcomeModal = ({ isOpen, onClose, onYes }) => { if (!isOpen) return null; return ( <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={onClose}> <div className="bg-white rounded-3xl p-6 w-full max-w-sm modal-enter text-center shadow-2xl" onClick={e => e.stopPropagation()}> <div className="text-5xl mb-4">ğŸ </div> <h3 className="text-xl font-black text-gray-800 mb-2 font-pop">ãŠã‹ãˆã‚Šãªã•ã„ï¼</h3> <p className="text-gray-600 font-bold mb-6 text-sm">å­¦æ ¡ãƒ»è·å ´ã‹ã‚‰å¸°å®…ã—ãŸï¼Ÿ<br/>ç§»å‹•ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ (-30HP)</p> <div className="flex gap-3"> <button onClick={onYes} className="flex-1 bg-pink-500 text-white font-bold py-3 rounded-xl shadow-md active:scale-95">ã¯ã„ï¼(è¨˜éŒ²)</button> <button onClick={onClose} className="flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-xl shadow-md active:scale-95">ã„ã„ãˆ</button> </div> </div> </div> ); };
        
        const BathConfirmModal = ({ isOpen, onClose, onConfirm }) => { if (!isOpen) return null; return ( <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={onClose}> <div className="bg-white rounded-3xl p-6 w-full max-w-sm modal-enter text-center shadow-2xl border-4 border-pink-100" onClick={e => e.stopPropagation()}> <div className="text-5xl mb-4">ğŸ›</div> <h3 className="text-xl font-black text-gray-800 mb-2 font-pop">ãŠé¢¨å‘‚ã‚¿ã‚¤ãƒ ï¼Ÿ</h3> <p className="text-gray-600 font-bold mb-6 text-sm">ãŠé¢¨å‘‚ã«å…¥ã£ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ<br/>(HPå…¨å›å¾© & ä»Šæ—¥ã®å ã„ï¼)</p> <div className="flex gap-3"> <button onClick={onConfirm} className="flex-1 bg-gradient-to-r from-pink-400 to-purple-400 text-white font-bold py-3 rounded-xl shadow-md active:scale-95">å…¥ã£ãŸï¼âœ¨</button> <button onClick={onClose} className="flex-1 bg-gray-100 text-gray-500 font-bold py-3 rounded-xl shadow-md active:scale-95">ã¾ã </button> </div> </div> </div> ); };
        
        const HelpModal = ({ isOpen, onClose }) => { if (!isOpen) return null; return ( <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={onClose}> <div className="bg-white rounded-3xl p-6 w-full max-w-sm modal-enter shadow-2xl relative border-4 border-pink-100 max-h-[80vh] overflow-y-auto" onClick={e => e.stopPropagation()}> <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><Icons.X /></button> <div className="text-center mb-6"> <h2 className="text-lg font-black text-gray-800 mb-1 font-pop">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h2> <p className="text-xs text-pink-500 font-bold">ãƒ•ãƒ­ãƒã‚¤ãƒƒã‚¿ï¼Ÿã¸ã‚ˆã†ã“ãï¼</p> </div> <div className="space-y-4 text-sm text-gray-600 font-bold"> <div className="bg-pink-50 p-3 rounded-xl flex items-start gap-3"> <div className="text-2xl">â¤ï¸</div> <div> <h4 className="text-pink-600 font-black mb-1">HPï¼ˆæ¸…æ½”åº¦ï¼‰ã‚’å®ˆã‚Œï¼</h4> <p className="text-xs leading-relaxed">æ™‚é–“ãŒçµŒã¤ã¨HPãŒæ¸›ã£ã¦ã„ãã¾ã™ã€‚0%ã«ãªã‚‹ã¨ã‚¾ãƒ³ãƒ“ã«ãªã£ã¡ã‚ƒã†ã‹ã‚‚â€¦ï¼ï¼Ÿ</p> </div> </div> <div className="bg-blue-50 p-3 rounded-xl flex items-start gap-3"> <div className="text-2xl">ğŸ›</div> <div> <h4 className="text-blue-600 font-black mb-1">ãŠé¢¨å‘‚ã§ãƒªã‚»ãƒƒãƒˆ</h4> <p className="text-xs leading-relaxed">ãŠé¢¨å‘‚ã«å…¥ã£ãŸã‚‰ä¸€ç•ªä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ï¼HPãŒå…¨å›å¾©ã—ã¦ã€ä»Šæ—¥ã®é‹å‹¢ãŒå ãˆã‚‹ã‚ˆâœ¨</p> </div> </div> <div className="bg-yellow-50 p-3 rounded-xl flex items-start gap-3"> <div className="text-2xl">ğŸŒ¤ï¸</div> <div> <h4 className="text-yellow-600 font-black mb-1">å¤©æ°—ã¨é€£å‹•</h4> <p className="text-xs leading-relaxed">æš‘ã„æ—¥ã¯æ±—ã‚’ã‹ãã‹ã‚‰HPã®æ¸›ã‚ŠãŒæ—©ããªã‚‹ã‚ˆã€‚ã€Œå¤©æ°—å–å¾—ã€ãƒœã‚¿ãƒ³ã§ãƒªã‚¢ãƒ«é€£æºã—ã‚ˆã†ï¼</p> </div> </div> <div className="bg-purple-50 p-3 rounded-xl flex items-start gap-3"> <div className="text-2xl">ğŸ”®</div> <div> <h4 className="text-purple-600 font-black mb-1">æœ¬æ ¼ãŠé¢¨å‘‚å ã„</h4> <p className="text-xs leading-relaxed">ãƒªã‚»ãƒƒãƒˆæ™‚ã«å ã„ãŒç™ºå‹•ï¼å…¥æµ´ã§é‹æ°—ã‚’ä¸Šã’ã¦ã€ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã‚ˆã†ï¼</p> </div> </div> </div> <button onClick={onClose} className="w-full bg-pink-500 text-white font-bold py-3 rounded-xl shadow-md mt-6 active:scale-95">ã‚ã‹ã£ãŸï¼</button> </div> </div> ); };
        
        const ActionButton = ({ icon, color, damage, label, onTrigger }) => { const [isCooldown, setIsCooldown] = useState(false); const handleClick = () => { if (isCooldown) return; onTrigger(); setIsCooldown(true); setTimeout(() => { setIsCooldown(false); }, 3000); }; return ( <button onClick={handleClick} disabled={isCooldown} className={`relative ${isCooldown ? 'bg-gray-300 scale-95' : color} w-16 h-16 rounded-full shadow-xl flex items-center justify-center text-3xl transition-all duration-300 border-4 border-white active:scale-90`}> {isCooldown ? <div className="w-6 h-6 border-2 border-gray-500 border-t-transparent rounded-full animate-spin"></div> : icon} <span className="absolute -bottom-6 text-[10px] font-bold text-gray-500 whitespace-nowrap bg-white/80 px-1 rounded">{label} -{damage}</span> </button> ); };
        
        // â˜…â˜…â˜… è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« (æ—¥èªŒ + ç°¡æ˜“å ã„) â˜…â˜…â˜…
        const DayDetailModal = ({ isOpen, onClose, details, logs, onOpenFortune }) => {
            if (!isOpen || !details) return null;

            const { dateStr, time, hoursSince, preBathHp, fortune } = details;
            // æ—¥æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const d = new Date(time);
            const displayDate = !isNaN(d) 
                ? d.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric', weekday: 'short' })
                : dateStr;
            const displayTime = !isNaN(d)
                ? d.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })
                : '--:--';

            // ãã®æ—¥ã®ãƒ­ã‚°ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const dayLogs = logs.filter(log => {
                if (!log.timestamp) return false;
                return getLocalDateStr(new Date(log.timestamp)) === dateStr;
            });

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-3xl p-6 w-full max-w-sm modal-enter shadow-2xl relative border-4 border-pink-300 flex flex-col max-h-[85vh]" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><Icons.X /></button>
                        
                        <div className="text-center mb-6 flex-shrink-0">
                            <h2 className="text-xl font-black text-gray-800 mb-1 font-pop">å…¥æµ´è©³ç´°è¨˜éŒ²</h2>
                            <p className="text-lg text-pink-500 font-bold">{displayDate}</p>
                            <p className="text-xs text-gray-400">{displayTime} ã®å…¥æµ´</p>
                        </div>
                        
                        <div className="space-y-4 overflow-y-auto pr-1 pb-4 flex-grow">
                            <div className="flex gap-3">
                                <div className="flex-1 bg-pink-50 p-3 rounded-xl text-center">
                                    <p className="text-[10px] font-bold text-gray-500 mb-1">ç›´å‰ã®ç››ã‚Œåº¦</p>
                                    <p className="text-3xl font-black text-pink-600 font-pop">{preBathHp !== undefined ? preBathHp : '?'}%</p>
                                </div>
                                <div className="flex-1 bg-blue-50 p-3 rounded-xl text-center">
                                    <p className="text-[10px] font-bold text-gray-500 mb-1">çµŒéæ™‚é–“</p>
                                    <p className="text-2xl font-black text-blue-600 font-pop">{hoursSince !== undefined ? hoursSince : '?'}H</p>
                                </div>
                            </div>
                            
                            {fortune ? (
                                <div 
                                    onClick={(e) => {
                                        // â˜…ä¿®æ­£ç®‡æ‰€: è¦ªã®onClick(é–‰ã˜ã‚‹å‡¦ç†)ã¸ã®ä¼æ’­ã‚’æ­¢ã‚ã‚‹
                                        e.stopPropagation();
                                        onOpenFortune(fortune);
                                    }}
                                    className={`p-4 rounded-xl border-2 border-dashed border-gray-300 bg-white hover:bg-gray-50 active:scale-95 transition-all cursor-pointer text-center relative overflow-hidden group`}
                                >
                                    <div className={`absolute top-0 left-0 w-2 h-full ${fortune.bg.replace('bg-', 'bg-')}`}></div>
                                    <p className="text-xs font-bold text-gray-400 mb-2">ã“ã®æ—¥ã®é‹å‹¢</p>
                                    <div className="flex items-center justify-center gap-3 mb-2">
                                        <span className="text-3xl">ğŸ”®</span>
                                        <span className={`text-3xl font-black ${fortune.color} font-pop`}>{fortune.rank}</span>
                                    </div>
                                    <div className="text-[10px] text-white bg-gray-400 inline-block px-3 py-1 rounded-full group-hover:bg-pink-400 transition-colors font-bold">
                                        ã‚¿ãƒƒãƒ—ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                                    </div>
                                </div>
                            ) : (
                                <div className="text-center py-4 bg-gray-50 rounded-xl text-gray-400 text-xs">
                                    å ã„ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“
                                </div>
                            )}

                            {/* æ—¥èªŒã‚¨ãƒªã‚¢ */}
                            <div className="mt-4">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="text-lg">ğŸ“</span>
                                    <span className="text-sm font-bold text-gray-600">ã“ã®æ—¥ã®è¡Œå‹•ãƒ­ã‚°</span>
                                </div>
                                {dayLogs.length > 0 ? (
                                    <div className="space-y-2 bg-gray-50 p-2 rounded-xl">
                                        {dayLogs.map((log, i) => (
                                            <div key={i} className="flex gap-2 items-start bg-white p-2 rounded-lg shadow-sm">
                                                <div className="text-base">{log.icon}</div>
                                                <div className="flex-1">
                                                    <div className="text-xs font-bold text-gray-700">{log.text}</div>
                                                    <div className="text-[10px] text-gray-400 text-right">{log.time}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-4 bg-gray-50 rounded-xl text-gray-400 text-xs">
                                        è¨˜éŒ²ã•ã‚ŒãŸè¡Œå‹•ã¯ã‚ã‚Šã¾ã›ã‚“
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        <button onClick={onClose} className="mt-2 w-full bg-gray-200 text-gray-600 font-bold py-3 rounded-xl shadow-sm active:scale-95 flex-shrink-0">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            );
        };

        const CalendarModal = ({ isOpen, onClose, bathEvents, onDayClick }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            
            const bathEventMap = new Map();
            const historySet = new Set();
            
            if (bathEvents && Array.isArray(bathEvents)) {
                bathEvents.forEach(evt => {
                    const dStr = typeof evt === 'string' ? evt : evt.dateStr;
                    historySet.add(dStr);
                    if (typeof evt !== 'string') {
                        if (!bathEventMap.has(dStr)) {
                            bathEventMap.set(dStr, evt);
                        }
                    }
                });
            }

            if (!isOpen) return null;

            const getDaysInMonth = (date) => {
                const year = date.getFullYear(); const month = date.getMonth();
                const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
                const firstDayOfWeek = new Date(year, month, 1).getDay();
                const days = []; for (let i = 0; i < firstDayOfWeek; i++) days.push(null);
                for (let i = 1; i <= lastDayOfMonth; i++) days.push(new Date(year, month, i));
                return days;
            };

            const calculateStreakAtDate = (targetDateStr, hSet) => {
                if (!hSet.has(targetDateStr)) return 0;
                let streak = 1;
                let current = new Date(targetDateStr);
                while (true) {
                    current.setDate(current.getDate() - 1);
                    const prevDateStr = getLocalDateStr(current);
                    if (hSet.has(prevDateStr)) streak++; else break;
                }
                return streak;
            };

            const calculateCurrentStreak = (hSet) => {
                const today = getLocalDateStr(new Date());
                const yesterday = getLocalDateStr(new Date(new Date().setDate(new Date().getDate()-1)));
                let start = hSet.has(today) ? today : hSet.has(yesterday) ? yesterday : null;
                return start ? calculateStreakAtDate(start, hSet) : 0;
            };

            const streak = calculateCurrentStreak(historySet);
            const days = getDaysInMonth(currentDate);
            const monthLabel = `${currentDate.getFullYear()}å¹´ ${currentDate.getMonth() + 1}æœˆ`;
            const getStamp = (s) => s >= 30 ? "ğŸŒˆ" : s >= 7 ? "ğŸ’" : s >= 3 ? "ğŸ‘‘" : "ğŸ’®";

            const CalendarView = () => (
                <>
                    <div className="flex justify-between items-center mb-4 px-2">
                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))} className="p-2 text-pink-400"><Icons.ChevronLeft size={20}/></button>
                        <span className="font-bold text-gray-800 text-lg block">{monthLabel}</span>
                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))} className="p-2 text-pink-400"><Icons.ChevronRight size={20}/></button>
                    </div>
                    <div className="calendar-grid mb-2 text-center text-xs font-bold text-gray-400 border-b border-gray-100 pb-2"><div className="text-red-400">æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div className="text-blue-400">åœŸ</div></div>
                    <div className="calendar-grid gap-1">
                        {days.map((date, i) => {
                            if (!date) return <div key={i}></div>;
                            const dateStr = getLocalDateStr(date);
                            const hasEntry = historySet.has(dateStr);
                            const s = calculateStreakAtDate(dateStr, historySet);
                            const isToday = date.toDateString() === new Date().toDateString();
                            const rotate = (date.getDate() * 13) % 20 - 10;
                            const eventDetails = bathEventMap.get(dateStr);
                            
                            return (
                                <div 
                                    key={i} 
                                    onClick={eventDetails ? () => onDayClick(eventDetails) : null}
                                    className={`calendar-cell ${isToday ? 'bg-pink-50 border border-pink-200' : ''} ${eventDetails ? 'cursor-pointer hover:bg-pink-100 active:scale-95 transition-all' : ''}`}
                                >
                                    <span className={`text-[10px] mb-0.5 ${isToday ? 'text-pink-600 font-bold' : 'text-gray-400'}`}>{date.getDate()}</span>
                                    {s > 0 && <span className="text-2xl absolute bottom-0 stamp-animate select-none" style={{ transform: `rotate(${rotate}deg)` }}>{getStamp(s)}</span>}
                                    {eventDetails && <div className="absolute top-0 right-0 text-pink-300 opacity-70 scale-50">ğŸ”</div>}
                                </div>
                            );
                        })}
                    </div>
                    <p className="text-[10px] text-gray-400 text-center mt-4">ğŸ”ãƒãƒ¼ã‚¯ã®æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã§è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèªï¼</p>
                </>
            );

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-3xl p-6 w-full max-w-sm modal-enter shadow-2xl relative border-4 border-pink-100 max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><Icons.X /></button>
                        <div className="text-center mb-6 flex-shrink-0">
                            <h2 className="text-sm text-gray-500 font-bold mb-1 font-pop">å±¥æ­´ç®¡ç†ã‚»ãƒ³ã‚¿ãƒ¼</h2>
                            <div className="text-4xl font-black text-pink-500 font-pop drop-shadow-sm flex items-center justify-center gap-2"><span>{streak}æ—¥</span><span className="animate-pulse">ğŸ”¥</span></div>
                        </div> 
                        
                        <div className="flex-grow overflow-y-auto">
                            <CalendarView />
                        </div>
                    </div>
                </div>
            );
        };

        const FortuneModal = ({ isOpen, onClose, result }) => { const [isFlipped, setIsFlipped] = useState(false); useEffect(() => { if (isOpen) { setIsFlipped(false); const timer = setTimeout(() => { setIsFlipped(true); if (navigator.vibrate) navigator.vibrate([50, 100]); }, 1000); return () => clearTimeout(timer); } }, [isOpen]); if (!isOpen || !result) return null; const StarRating = ({ count }) => ( <div className="flex text-sm"> {[...Array(5)].map((_, i) => ( <span key={i} className={i < count ? "star-rating" : "star-rating-gray"}>â˜…</span> ))} </div> ); return ( <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-6" onClick={isFlipped ? onClose : null}> <div className="w-full max-w-sm aspect-[3/4] perspective-1000" onClick={e => e.stopPropagation()}> <div className={`card-inner relative w-full h-full duration-700 transform-style-3d cursor-pointer ${isFlipped ? 'flipped' : ''}`} onClick={() => !isFlipped && setIsFlipped(true)}> <div className="card-front"> <div className="text-6xl animate-pulse">ğŸ”®</div> <p className="mt-4 text-pink-400 font-bold font-pop">æ¹¯ã®è¨—å®£</p> <p className="text-xs text-gray-400 mt-2">å¿ƒã‚’é®ã‚ã¦ã‚¿ãƒƒãƒ—...</p> </div> <div className="card-back overflow-hidden relative"> <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pink-400 to-purple-400"></div> <div className="p-6 flex flex-col h-full w-full"> <div className="text-center mb-4"> <p className="text-xs text-gray-400 font-bold mb-1">å…¥æµ´é‹å‹¢</p> <h2 className={`text-4xl font-black font-pop ${result.color} tracking-widest`}>{result.rank}</h2> <p className="text-[10px] text-gray-400 font-bold mt-1 tracking-widest">- {result.read} -</p> <h3 className="text-sm font-bold text-gray-700 mt-2">ã€Œ{result.title}ã€</h3> </div> <div className="bg-gray-50 rounded-xl p-3 mb-4 text-xs font-bold text-gray-600 leading-relaxed text-center flex-grow flex items-center justify-center"> {result.desc} </div> <div className="space-y-2 mb-4"> <div className="flex justify-between items-center bg-pink-50 px-3 py-1.5 rounded-lg"> <span className="text-xs font-bold text-pink-500">æ‹æ„›é‹</span> <StarRating count={result.love} /> </div> <div className="flex justify-between items-center bg-yellow-50 px-3 py-1.5 rounded-lg"> <span className="text-xs font-bold text-yellow-600">é‡‘é‹</span> <StarRating count={result.money} /> </div> <div className="flex justify-between items-center bg-green-50 px-3 py-1.5 rounded-lg"> <span className="text-xs font-bold text-green-600">å¥åº·é‹</span> <StarRating count={result.health} /> </div> </div> <div className="mt-auto text-center"> <div className="text-[10px] text-purple-500 font-bold mb-1">âœ¨ ãƒ©ãƒƒã‚­ãƒ¼ãƒã‚¹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ âœ¨</div> <div className="bg-purple-100 text-purple-700 font-bold py-2 px-4 rounded-full text-xs inline-block shadow-sm"> {result.action} </div> </div> <button onClick={onClose} className="mt-4 text-xs text-gray-400 underline">é–‰ã˜ã‚‹</button> </div> </div> </div> </div> </div> ); };

        const App = () => {
            const [hp, setHp] = useState(100);
            const [lastBathTime, setLastBathTime] = useState(new Date());
            const [eventDamageTotal, setEventDamageTotal] = useState(0);
            const [logs, setLogs] = useState([]);
            const [bathEvents, setBathEvents] = useState([]); 
            const [weatherData, setWeatherData] = useState(null); 
            const [isBgmPlaying, setIsBgmPlaying] = useState(false);

            const [isCalendarOpen, setIsCalendarOpen] = useState(false);
            const [isFortuneOpen, setIsFortuneOpen] = useState(false);
            const [isHelpOpen, setIsHelp] = useState(false);
            const [fortuneResult, setFortuneResult] = useState(null);
            
            const [selectedDateDetails, setSelectedDateDetails] = useState(null);

            const [showWelcomeModal, setShowWelcomeModal] = useState(false);
            const [showInAppWarning, setShowInAppWarning] = useState(false);
            const [showInstallGuide, setShowInstallGuide] = useState(false);
            const [showBathConfirmModal, setShowBathConfirmModal] = useState(false);
            
            const [isGenerating, setIsGenerating] = useState(false);
            const [generatedImage, setGeneratedImage] = useState(null);
            const [isFetchingWeather, setIsFetchingWeather] = useState(false);

            const audioRef = useRef(null);
            const sePopRef = useRef(null);
            const seKiraRef = useRef(null);

            useEffect(() => {
                audioRef.current = new Audio(BGM_URL);
                audioRef.current.loop = true;
                audioRef.current.volume = 0.3;

                sePopRef.current = new Audio(SE_POP_URL);
                seKiraRef.current = new Audio(SE_KIRA_URL);

                const handleVisibilityChange = () => {
                    if (document.hidden) {
                        if (audioRef.current) audioRef.current.pause();
                    } else {
                        if (isBgmPlaying && audioRef.current) {
                            audioRef.current.play().catch(e => console.log("Resume error", e));
                        }
                    }
                };
                document.addEventListener("visibilitychange", handleVisibilityChange);

                return () => {
                    document.removeEventListener("visibilitychange", handleVisibilityChange);
                    if (audioRef.current) {
                        audioRef.current.pause();
                        audioRef.current = null;
                    }
                };
            }, [isBgmPlaying]);

            const toggleBgm = () => {
                if (!audioRef.current) return;
                if (isBgmPlaying) {
                    audioRef.current.pause();
                } else {
                    audioRef.current.play().catch(e => console.log("å†ç”Ÿã‚¨ãƒ©ãƒ¼:", e));
                }
                setIsBgmPlaying(!isBgmPlaying);
            };

            const playSe = (type) => {
                const audio = type === 'kira' ? seKiraRef.current : sePopRef.current;
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => {}); 
                }
            };

            useEffect(() => { 
                const load = (k) => localStorage.getItem(k); 
                if (load(STORAGE_KEY_HP)) setHp(parseFloat(load(STORAGE_KEY_HP))); 
                if (load(STORAGE_KEY_LAST_BATH)) setLastBathTime(new Date(load(STORAGE_KEY_LAST_BATH))); 
                if (load(STORAGE_KEY_DAMAGE)) setEventDamageTotal(parseFloat(load(STORAGE_KEY_DAMAGE))); 
                if (load(STORAGE_KEY_LOGS)) setLogs(JSON.parse(load(STORAGE_KEY_LOGS))); 
                
                if (load(STORAGE_KEY_HISTORY)) {
                    const loadedHistory = JSON.parse(load(STORAGE_KEY_HISTORY));
                    if (Array.isArray(loadedHistory)) {
                        if (loadedHistory.length > 0 && typeof loadedHistory[0] === 'string') {
                            const migrated = loadedHistory.map(dStr => ({
                                dateStr: dStr,
                                time: new Date(dStr).toISOString(), 
                                preBathHp: '?',
                                hoursSince: '?',
                                fortune: null
                            }));
                            setBathEvents(migrated);
                        } else {
                            setBathEvents(loadedHistory);
                        }
                    }
                }
                
                if (load(STORAGE_KEY_WEATHER)) setWeatherData(JSON.parse(load(STORAGE_KEY_WEATHER))); 

                const ua = navigator.userAgent.toLowerCase(); 
                if (/line|instagram|twitter|fbav|fban/.test(ua)) { setShowInAppWarning(true); } 
                else { 
                    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone; 
                    if (!isStandalone) setTimeout(() => setShowInstallGuide(true), 2000); 
                } 
                const lastLogin = localStorage.getItem('hq_last_login'); 
                const now = new Date(); 
                if (lastLogin) { 
                    const diff = (now - new Date(lastLogin)) / (1000 * 60 * 60); 
                    if (diff > 6 && diff < 16) { setShowWelcomeModal(true); } 
                } 
                localStorage.setItem('hq_last_login', now.toISOString()); 
            }, []);

            useEffect(() => { 
                localStorage.setItem(STORAGE_KEY_HP, hp.toString()); 
                localStorage.setItem(STORAGE_KEY_LAST_BATH, lastBathTime.toISOString()); 
                localStorage.setItem(STORAGE_KEY_DAMAGE, eventDamageTotal.toString()); 
                localStorage.setItem(STORAGE_KEY_LOGS, JSON.stringify(logs)); 
                localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(bathEvents)); 
                if (weatherData) localStorage.setItem(STORAGE_KEY_WEATHER, JSON.stringify(weatherData)); 
            }, [hp, lastBathTime, eventDamageTotal, logs, bathEvents, weatherData]);

            const getWeatherDamageRate = () => { if (!weatherData) return 1.0; const t = weatherData.temperature; if (t >= 30) return 1.5; if (t >= 25) return 1.2; if (t <= 10) return 0.8; return 1.0; };
            const weatherRate = getWeatherDamageRate();
            const [currentTime, setCurrentTime] = useState(new Date());
            useEffect(() => { const timer = setInterval(() => setCurrentTime(new Date()), 5000); return () => clearInterval(timer); }, []);
            
            useEffect(() => { 
                const diffMs = new Date() - lastBathTime; 
                const hours = diffMs / (1000 * 60 * 60); 
                const timeDamage = hours * BASE_RATE_PER_HOUR * weatherRate; 
                const totalDamage = timeDamage + eventDamageTotal; 
                setHp(Math.max(0, Math.min(100, 100 - totalDamage))); 
            }, [currentTime, lastBathTime, eventDamageTotal, weatherRate]);

            const addLog = (text, icon) => { 
                const now = new Date();
                const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }); 
                setLogs(prev => [{ timestamp: now.toISOString(), time: timeStr, text, icon: icon || "ğŸ“±" }, ...prev].slice(0, 150)); 
            };

            const fetchWeather = () => {
                playSe('pop');
                setIsFetchingWeather(true);
                const handleWeatherData = (temp, isFallback = false) => {
                    setWeatherData({ temperature: temp, updated: new Date().toISOString() });
                    if (isFallback) { addLog(`ä½ç½®æƒ…å ±ãŒå–ã‚Œãªã„ãŸã‚æ±äº¬ã®æ°—æ¸©(${temp}Â°C)ã‚’å–å¾—ã—ã¾ã—ãŸ`, "ğŸ—¼"); } 
                    else { addLog(`å¤©æ°—å–å¾—å®Œäº†ï¼ç¾åœ¨${temp}Â°C`, "ğŸŒ¤ï¸"); }
                    if (temp >= 30) addLog("çŒ›æš‘ã‚¢ãƒ©ãƒ¼ãƒˆç™ºä»¤ğŸ¥µ ãƒ€ãƒ¡ãƒ¼ã‚¸1.5å€ï¼", "ğŸ”¥");
                    else if (temp >= 25) addLog("æš‘ã„...æ±—ã°ã‚€... ãƒ€ãƒ¡ãƒ¼ã‚¸1.2å€ğŸ’¦", "ğŸ’¦");
                    else if (temp <= 10) addLog("å¯’ã„...æ±—ã‹ã‹ãªã„ãƒœãƒ¼ãƒŠã‚¹â„ï¸ ãƒ€ãƒ¡ãƒ¼ã‚¸0.8å€", "â„ï¸");
                    setIsFetchingWeather(false);
                };
                const fetchTokyoWeather = async () => {
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&current_weather=true`);
                        if (!res.ok) throw new Error('API Error');
                        const data = await res.json();
                        handleWeatherData(data.current_weather.temperature, true);
                    } catch (e) { addLog("å¤©æ°—ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸğŸ’¦", "âŒ"); setIsFetchingWeather(false); }
                };
                if (!navigator.geolocation) { fetchTokyoWeather(); return; }
                const options = { timeout: 10000, maximumAge: 0 };
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const { latitude, longitude } = pos.coords;
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`);
                        if (!res.ok) throw new Error('API Error');
                        const data = await res.json();
                        handleWeatherData(data.current_weather.temperature, false);
                    } catch(e) { fetchTokyoWeather(); }
                }, (err) => { console.warn(`Geolocation Error(${err.code}): ${err.message}`); fetchTokyoWeather(); }, options);
            };

            const handleBath = () => {
                setShowBathConfirmModal(false);
                
                const now = new Date();
                const diffMs = now - lastBathTime;
                const hoursSince = (diffMs / (1000 * 60 * 60)); 
                const fortune = generateFortune();

                const newEvent = {
                    dateStr: getLocalDateStr(now),
                    time: now.toISOString(),
                    hoursSince: hoursSince.toFixed(1),
                    preBathHp: Math.floor(hp),
                    fortune: fortune
                };

                setBathEvents(prev => [newEvent, ...prev]);

                setLastBathTime(now);
                setEventDamageTotal(0);
                setHp(100);
                addLog("ãŠé¢¨å‘‚å…¥ã£ã¦å¾©æ´»ï¼ä»Šæ—¥ã‚‚ç§ãŒä¸€ç•ªã‚«ãƒ¯ã‚¤ã‚¤ğŸ’–", "ğŸ›");
                
                setFortuneResult(fortune);
                setTimeout(() => {
                  playSe('kira'); 
                   setIsFortuneOpen(true);
              }, 500);
                if (navigator.vibrate) navigator.vibrate([0, 100, 50, 100]);
            };

            const drawRoundedRect = (ctx, x, y, w, h, r) => { ctx.beginPath(); ctx.moveTo(x + r, y); ctx.arcTo(x + w, y, x + w, y + h, r); ctx.arcTo(x + w, y + h, x, y + h, r); ctx.arcTo(x, y + h, x, y, r); ctx.arcTo(x, y, x + w, y, r); ctx.closePath(); };

            const generateShareImage = async () => {
                playSe('pop');
                setIsGenerating(true);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const W = 800; const H = 1200;
                canvas.width = W; canvas.height = H;

                try {
                    ctx.fillStyle = '#fdf2f8'; ctx.fillRect(0, 0, W, H);
                    ctx.fillStyle = '#fbcfe8'; for(let i=0; i<W; i+=40) { for(let j=0; j<H; j+=40) { if ((i+j)%80 === 0) { ctx.beginPath(); ctx.arc(i, j, 8, 0, Math.PI*2); ctx.fill(); } } }

                    const currentStatus = getStatus(hp);
                    const cx = W/2; const cy = 350;

                    ctx.shadowBlur = 60; ctx.shadowColor = currentStatus.glow.includes('pink') ? '#f472b6' : currentStatus.glow.includes('yellow') ? '#facc15' : currentStatus.glow.includes('purple') ? '#c084fc' : '#9ca3af';
                    ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.beginPath(); ctx.arc(cx, cy, 200, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0; 

                    ctx.textAlign = 'center';
                    ctx.font = '200px sans-serif';
                    ctx.fillText('ğŸ›', cx, cy + 60);

                    ctx.fillStyle = '#ec4899';
                    ctx.font = '900 60px "Mochiy Pop One"';
                    ctx.fillText('ãƒ•ãƒ­ãƒã‚¤ãƒƒã‚¿ï¼Ÿ', cx, cy + 220);

                    ctx.fillStyle = 'rgba(255,255,255,0.8)'; drawRoundedRect(ctx, 100, 650, 600, 120, 20); ctx.fill(); ctx.strokeStyle = '#fbcfe8'; ctx.stroke();
                    ctx.fillStyle = '#f472b6'; ctx.font = 'bold 24px "Zen Maru Gothic"'; ctx.fillText('ãŠé¢¨å‘‚ã«å…¥ã‚‰ãš...', W/2, 690); ctx.font = '900 60px "Mochiy Pop One"'; ctx.fillStyle = '#db2777'; ctx.fillText(`${hoursSince} æ™‚é–“`, W/2, 750);
                    
                    ctx.fillStyle = 'rgba(255,255,255,0.9)'; drawRoundedRect(ctx, 50, 800, 700, 250, 30); ctx.fill();
                    ctx.fillStyle = '#6b7280'; ctx.font = 'bold 30px "Zen Maru Gothic"'; ctx.textAlign = 'left'; ctx.fillText('ç¾åœ¨ã®æ¸…æ½”åº¦', 100, 860); ctx.textAlign = 'right'; ctx.font = '900 80px "Mochiy Pop One"'; ctx.fillStyle = '#ec4899'; ctx.fillText(`${Math.floor(hp)}%`, 700, 880);
                    
                    ctx.textAlign = 'center'; ctx.fillStyle = '#374151'; ctx.font = 'bold 36px "Yomogi"'; ctx.fillText(`ã€Œ${currentStatus.shareMsg}ã€`, W/2, 980);

                    ctx.fillStyle = '#9ca3af'; ctx.font = 'bold 24px "Mochiy Pop One"'; ctx.textAlign = 'center'; ctx.fillText('ğŸ› ãŠé¢¨å‘‚å…¥ã£ã¦ç››ã‚Œåº¦UPï¼', W/2, 1150);

                    canvas.toBlob(async (blob) => {
                        if (!blob) throw new Error("Canvas Error");
                        const file = new File([blob], "share.png", { type: "image/png" });
                        const dataUrl = URL.createObjectURL(blob);
                        setGeneratedImage(dataUrl);
                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            try {
                                const url = 'https://ioriiroikw-eng.github.io/bath-check/';
                                const title = 'ãƒ•ãƒ­ãƒã‚¤ãƒƒã‚¿ï¼Ÿ';
                                const text = `æ¸…æ½”åº¦ãƒã‚§ãƒƒã‚¯ï¼ #ãƒ•ãƒ­ãƒã‚¤ãƒƒã‚¿\n${url}`;
                                await navigator.share({ title: title, text: text, url: url, files: [file] });
                            } catch (err) { console.log("Share canceled"); }
                        }
                    }, 'image/png');
                } catch (e) { console.error(e); alert("ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸğŸ’¦"); } finally { setIsGenerating(false); }
            };

            const getStatus = (hp) => {
                if (hp >= 80) return { avatar: "./char_80.png", label: "å¤§å‹åˆ©", deco: "ğŸ‘‘", shareMsg: "å…¨äººé¡è¦‹ã¦âœ¨", glow: "bg-pink-400" };
                if (hp >= 50) return { avatar: "./char_50.png", label: "å¤©ä½¿", deco: "âœ¨", shareMsg: "ã¾ã èˆãˆã‚‹ã¯ãš", glow: "bg-yellow-200" };
                if (hp >= 20) return { avatar: "./char_20.png", label: "é™ç•Œ", deco: "ğŸ’¦", shareMsg: "åŠå¾„2mæ¥è¿‘ç¦æ­¢", glow: "bg-purple-300" };
                return { avatar: "./char_00.png", label: "çµ‚äº†", deco: "ğŸ’€", shareMsg: "ç¤¾ä¼šçš„ã«æ­»ğŸ˜‡", glow: "bg-gray-500" };
            };
            
            const status = getStatus(hp);
            const hoursSince = ((new Date() - lastBathTime) / (1000 * 60 * 60)).toFixed(1);

            return (
                <div className="min-h-screen w-full flex flex-col items-center py-6 px-4 pb-safe relative">
                    <div className="float-bg">{[...Array(15)].map((_,i)=><div key={i} className="float-item" style={{left:`${Math.random()*100}%`, animationDuration:`${15+Math.random()*20}s`, animationDelay:`${Math.random()*10}s`, fontSize:`${10+Math.random()*20}px`}}>{i%3===0?'ğŸ’–':i%3===1?'âœ¨':'ğŸ›'}</div>)}</div>
                    
                    {showInAppWarning && <InAppBrowserWarning onClose={() => setShowInAppWarning(false)} />}
                    {showInstallGuide && <InstallGuide onClose={() => setShowInstallGuide(false)} />}
                    <WelcomeModal isOpen={showWelcomeModal} onClose={() => setShowWelcomeModal(false)} onYes={() => { setEventDamageTotal(prev => prev + 30); addLog("ãŠã‹ãˆã‚Šè‡ªå‹•è¨˜éŒ² (-30)", "ğŸ "); setShowWelcomeModal(false); }} />
                    <BathConfirmModal isOpen={showBathConfirmModal} onClose={() => setShowBathConfirmModal(false)} onConfirm={handleBath} />
                    <HelpModal isOpen={isHelpOpen} onClose={() => setIsHelp(false)} />
                    <FortuneModal isOpen={isFortuneOpen} onClose={() => setIsFortuneOpen(false)} result={fortuneResult} />
                    
                    {/* è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« (logsã‚‚æ¸¡ã™) */}
                    <DayDetailModal 
                        isOpen={!!selectedDateDetails} 
                        onClose={() => setSelectedDateDetails(null)} 
                        details={selectedDateDetails} 
                        logs={logs}
                        onOpenFortune={(result) => {
                            setFortuneResult(result);
                            setIsFortuneOpen(true);
                        }}
                    />

                    <div className="w-full flex justify-between items-center pt-safe mb-4 mt-2 relative z-20 px-2">
                        <div className="flex gap-2">
                            <button onClick={() => { playSe('pop'); setIsCalendarOpen(true); }} className="bg-white/80 p-3 rounded-full shadow-md text-pink-500 hover:scale-110 transition-transform"><Icons.Calendar size={24} /></button>
                            <button onClick={toggleBgm} className={`p-3 rounded-full shadow-md transition-transform ${isBgmPlaying ? 'bg-pink-500 text-white animate-pulse' : 'bg-white/80 text-pink-500'}`}><Icons.Music size={24} /></button>
                            <button onClick={() => { playSe('pop'); setIsHelp(true); }} className="bg-white/80 p-3 rounded-full shadow-md text-pink-500 hover:scale-110 transition-transform"><Icons.Help size={24} /></button>
                        </div>
                        
                        <div className="flex gap-2">
                            <button 
                                onClick={() => {
                                    const text = `ç¾åœ¨ã®æ¸…æ½”åº¦: ${Math.floor(hp)}% (${status.label})\nãŠé¢¨å‘‚ã«å…¥ã‚‰ãš${hoursSince}æ™‚é–“ãŒçµŒé... ${status.deco}\n\nãŠé¢¨å‘‚ç¿’æ…£ã‚¢ãƒ—ãƒªã€Œãƒ•ãƒ­ãƒã‚¤ãƒƒã‚¿ï¼Ÿã€ã§ãƒã‚§ãƒƒã‚¯ï¼ #ãƒ•ãƒ­ãƒã‚¤ãƒƒã‚¿`;
                                    const url = "https://ioriiroikw-eng.github.io/bath-check/";
                                    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
                                }}
                                className="bg-white/80 p-3 rounded-full shadow-md text-pink-500 hover:scale-110 transition-transform"
                            >
                                <Icons.XLogo size={24} />
                            </button>
                            
                            <button onClick={() => generateShareImage()} disabled={isGenerating} className="bg-white/80 p-3 rounded-full shadow-md text-pink-500 hover:scale-110 transition-transform disabled:opacity-50">
                                {isGenerating ? <div className="animate-spin w-6 h-6 border-2 border-pink-500 border-t-transparent rounded-full"></div> : <Icons.Camera size={24} />}
                            </button>
                        </div>
                    </div>

                    <div className="w-full max-w-sm mb-4">
                        {!weatherData ? ( 
                            <button onClick={fetchWeather} disabled={isFetchingWeather} className="w-full bg-blue-50 border-2 border-blue-200 text-blue-500 font-bold py-2 rounded-xl shadow-sm text-xs flex items-center justify-center gap-2 transition-transform active:scale-95"> 
                                {isFetchingWeather ? <div className="animate-spin w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full"></div> : <Icons.Cloud size={16} />} <span>ç¾åœ¨åœ°ã®å¤©æ°—ã‚’å–å¾—ã—ã¦ãƒªã‚¢ãƒ«é€£æº (Î²)</span> 
                            </button> 
                        ) : ( 
                            <div className="w-full bg-white/80 border-2 border-blue-100 rounded-xl p-3 flex items-center justify-between shadow-sm relative overflow-hidden"> 
                                {weatherRate > 1.0 && <div className="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-bl-lg animate-pulse">ãƒ€ãƒ¡ãƒ¼ã‚¸åŠ é€Ÿä¸­!</div>} 
                                {weatherRate < 1.0 && <div className="absolute top-0 right-0 bg-blue-400 text-white text-[10px] font-bold px-2 py-0.5 rounded-bl-lg">å¿«é©ãƒœãƒ¼ãƒŠã‚¹ä¸­!</div>} 
                                <div className="flex items-center gap-3"> 
                                    <div className="text-3xl">{weatherData.temperature >= 25 ? 'ğŸ¥µ' : weatherData.temperature <= 10 ? 'ğŸ¥¶' : 'ğŸŒ¤ï¸'}</div> 
                                    <div> 
                                        <div className="text-xs font-bold text-gray-400">ç¾åœ¨ã®æ°—æ¸©</div> 
                                        <div className="text-xl font-black text-gray-700 font-pop">{weatherData.temperature}Â°C</div> 
                                    </div> 
                                </div> 
                                <div className="text-right"> 
                                    <div className="text-[10px] font-bold text-gray-400">ãƒ€ãƒ¡ãƒ¼ã‚¸å€ç‡</div> 
                                    <div className={`text-lg font-black font-pop ${weatherRate > 1.0 ? 'text-red-500' : weatherRate < 1.0 ? 'text-blue-500' : 'text-gray-600'}`}>x{weatherRate}</div> 
                                </div> 
                                <button onClick={fetchWeather} className="absolute bottom-2 right-2 text-gray-300 p-1 hover:text-blue-400"><Icons.Cloud size={12} /></button> 
                            </div> 
                        )}
                    </div>

                    <div className="w-full max-w-sm glass-card rounded-3xl p-6 mb-6 text-center relative overflow-visible">
                        <div className="absolute -top-6 -right-1 text-6xl animate-bounce z-20 filter drop-shadow-lg">{status.deco}</div>
                        <div className="absolute top-0 left-0 bg-pink-500 text-white text-xs font-bold px-3 py-1 rounded-br-2xl rounded-tl-2xl shadow-sm z-10 font-pop">{status.label}</div>
                        <div className="w-40 h-40 mx-auto mt-8 mb-6 relative purupuru select-none flex items-center justify-center">
                            <div className={`absolute inset-2 rounded-full opacity-60 blur-2xl ${status.glow}`} style={{transform: 'translate3d(0,0,0)'}}></div>
                            <img src={status.avatar} alt={status.label} className="relative z-10 w-32 h-32 object-contain drop-shadow-md rounded-full" />
                        </div>
                        <div className="relative pt-1 mb-2"> 
                            <div className="flex mb-2 items-center justify-between font-pop"> 
                                <span className="text-sm font-bold inline-block py-1 px-3 uppercase rounded-full text-white bg-pink-400 shadow-md">ç››ã‚Œåº¦</span> 
                                <span className="text-2xl font-black text-pink-500 drop-shadow-sm">{Math.floor(hp)}%</span> 
                            </div> 
                            <div className="h-6 w-full rounded-full meter-track relative mt-2"><div style={{ width: `${hp}%` }} className="h-full rounded-full meter-fill relative"></div><div style={{ left: `calc(${hp}% - 12px)` }} className="absolute top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center meter-icon"><span className="text-2xl">ğŸ’–</span></div></div> 
                        </div>
                        <div className="relative bg-white/80 rounded-xl p-4 border-2 border-pink-100 shadow-sm mt-4"> 
                            <div className="absolute -top-3 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-white border-t-2 border-l-2 border-pink-100 rotate-45"></div> 
                            <p className="font-bold text-gray-700 leading-relaxed text-sm font-hand">{status.shareMsg}</p> 
                        </div>
                    </div>

                    <div className="bg-white/80 px-6 py-3 rounded-2xl mb-8 shadow-md border-2 border-white flex items-center justify-between w-full max-w-sm"> 
                        <div className="flex items-center gap-2 text-pink-400"><Icons.Clock size={20} /><span className="text-xs font-bold">çµŒéæ™‚é–“</span></div> 
                        <span className="text-2xl font-black text-pink-500 font-pop">{hoursSince}<span className="text-sm ml-1 text-pink-400">H</span></span> 
                    </div>
                    
                    <button onClick={() => { playSe('pop'); setShowBathConfirmModal(true); }} className="w-full max-w-sm bg-gradient-to-r from-pink-400 to-purple-400 hover:from-pink-500 hover:to-purple-500 text-white font-black py-4 rounded-full shadow-lg border-4 border-white active:scale-95 transition-all mb-8 flex items-center justify-center gap-2 text-lg font-pop relative overflow-hidden group"> 
                        <div className="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div> 
                        <Icons.Bath size={24} /> <span>ãŠé¢¨å‘‚å…¥ã£ã¦ãƒªã‚»ãƒƒãƒˆâœ¨</span> 
                    </button>

                    <div className="fixed bottom-6 left-0 right-0 flex justify-center gap-4 z-40 pointer-events-none"> 
                        <div className="pointer-events-auto"> <ActionButton icon="ğŸ’¦" color="bg-blue-400" damage={30} label="é‹å‹•" onTrigger={()=>{ playSe('pop'); setEventDamageTotal(p=>p+30); addLog("ãƒœã‚¿ãƒ³: é‹å‹•ã—ãŸï¼ (-30)", "ğŸ’¦"); if(navigator.vibrate) navigator.vibrate([50,50]);}} /> </div> 
                        <div className="pointer-events-auto"> <ActionButton icon="ğŸ–" color="bg-orange-400" damage={10} label="é£Ÿäº‹" onTrigger={()=>{ playSe('pop'); setEventDamageTotal(p=>p+10); addLog("ãƒœã‚¿ãƒ³: é£Ÿäº‹ (-10)", "ğŸ–"); if(navigator.vibrate) navigator.vibrate(100);}} /> </div> 
                        <div className="pointer-events-auto"> <ActionButton icon="ğŸ›Œ" color="bg-purple-400" damage={20} label="ç¡çœ " onTrigger={()=>{ playSe('pop'); setEventDamageTotal(p=>p+20); addLog("ãƒœã‚¿ãƒ³: å¯ã¦èµ·ããŸ (-20)", "ğŸ›Œ"); if(navigator.vibrate) navigator.vibrate(50);}} /> </div> 
                    </div>

                    <CalendarModal 
                        isOpen={isCalendarOpen} 
                        onClose={() => setIsCalendarOpen(false)} 
                        bathEvents={bathEvents} 
                        onDayClick={(details) => {
                            playSe('pop');
                            setSelectedDateDetails(details);
                            setIsCalendarOpen(false); 
                        }}
                    />

                    {generatedImage && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6" onClick={() => setGeneratedImage(null)}>
                            <div className="bg-white rounded-3xl p-4 w-full max-w-sm relative" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setGeneratedImage(null)} className="absolute -top-3 -right-3 bg-gray-500 text-white p-2 rounded-full"><Icons.X size={16}/></button>
                                <h3 className="text-center font-bold text-gray-700 mb-2 font-pop">ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜ã—ã¦ã­ï¼</h3>
                                <img src={generatedImage} alt="Share" className="w-full rounded-xl border border-gray-200 shadow-inner" />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>