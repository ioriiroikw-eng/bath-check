<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#fdf2f8">
    <title>ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼</title>
    
    <meta property="og:title" content="ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼ï½œB.A.T.H.è¨ºæ–­">
    <meta property="og:description" content="ç§ã®ãŠé¢¨å‘‚ã‚¿ã‚¤ãƒ—ã¯...ï¼Ÿã‚ãªãŸã®å…¥æµ´æ€§æ ¼ã‚’è¨ºæ–­ã—ã¦ã¿ãªã„ï¼Ÿ #ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼">
    <meta property="og:type" content="website">
    <meta property="og:image" content="icon.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Yomogi&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png">

    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: #fdf2f8; overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; background-image: radial-gradient(#fbcfe8 20%, transparent 20%), radial-gradient(#fbcfe8 20%, transparent 20%); background-position: 0 0, 10px 10px; background-size: 20px 20px; user-select: none; }
        .font-pop { font-family: 'Mochiy Pop One', sans-serif; }
        .font-hand { font-family: 'Yomogi', cursive; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .purupuru { animation: purupuru 2s infinite; }
        @keyframes purupuru { 0% { transform: scale(1, 1); } 10% { transform: scale(1.02, 0.98); } 40% { transform: scale(0.98, 1.02); } 50% { transform: scale(1, 1); } }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 3px solid rgba(255, 255, 255, 1); box-shadow: 0 8px 32px 0 rgba(236, 72, 153, 0.15); border-radius: 32px; }
        .meter-track { background: #f3f4f6; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .meter-fill { background: linear-gradient(90deg, #f9a8d4, #ec4899, #fbbf24); box-shadow: 0 2px 4px rgba(236, 72, 153, 0.3); }
        .meter-icon { filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); transition: left 0.5s ease-out; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .calendar-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 4px; font-size: 12px; position: relative; background: rgba(255,255,255,0.5); border-radius: 8px; }
        @keyframes stampIn { 0% { opacity: 0; transform: scale(2) rotate(0deg); } 50% { opacity: 1; transform: scale(0.8); } 70% { transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
        .stamp-animate { animation: stampIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; display: inline-block; line-height: 1; }
        .modal-enter { animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalPop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .float-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; overflow: hidden; }
        .float-item { position: absolute; opacity: 0.3; animation: floatUp linear infinite; }
        @keyframes floatUp { 0% { transform: translateY(100vh) rotate(0deg); opacity: 0; } 100% { transform: translateY(-100px) rotate(360deg); opacity: 0; } }
        
        /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .slide-up { animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- è¨­å®šãƒ»å®šæ•° ---
        const BASE_RATE_PER_HOUR = 2.5; 
        const STORAGE_KEY_HP = 'hq_hp';
        const STORAGE_KEY_LAST_BATH = 'hq_last_bath';
        const STORAGE_KEY_DAMAGE = 'hq_damage';
        const STORAGE_KEY_LOGS = 'hq_logs';
        const STORAGE_KEY_HISTORY = 'hq_history';
        const STORAGE_KEY_USER_TYPE = 'hq_user_type_v2'; 

        const getLocalDateStr = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- ã‚¢ã‚¤ã‚³ãƒ³ ---
        const Icon = ({ path, className, size = 24, onClick }) => (
            <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const Icons = {
            Bath: (p) => <Icon {...p} path={<><path d="M9 6 6.5 3.5a1.5 1.5 0 0 0-1-1.5C3.81 2 2.5 3.31 2.5 5.5c0 1.56 1.15 2.1 1.8 2.2"/><path d="M21 10c0-1.66-1.34-3-3-3-1.12 0-2.1.58-2.6 1.5L14 10"/><path d="M7 10h14L19.5 21h-11Z"/><path d="M7 10v4"/></>} />,
            Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
            Calendar: (p) => <Icon {...p} path={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>} />,
            X: (p) => <Icon {...p} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            ChevronLeft: (p) => <Icon {...p} path={<><path d="m15 18-6-6 6-6"/></>} />,
            ChevronRight: (p) => <Icon {...p} path={<><path d="m9 18 6-6-6-6"/></>} />,
            Camera: (p) => <Icon {...p} path={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />,
            Share: (p) => <Icon {...p} path={<><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></>} />,
            Alert: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />,
            IosShare: (p) => <Icon {...p} path={<><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></>} />,
        };

        // --- ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶è­¦å‘Šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
        const InAppBrowserWarning = ({ onClose }) => (
            <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6 modal-enter">
                <div className="bg-white rounded-3xl p-6 w-full max-w-sm text-center relative border-4 border-pink-400">
                    <div className="text-pink-500 mb-2 flex justify-center"><Icons.Alert size={48} /></div>
                    <h2 className="text-xl font-black text-gray-800 mb-2 font-pop">âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¡ã‚ƒã†ã‹ã‚‚ï¼</h2>
                    <p className="text-sm text-gray-600 mb-4 font-bold">ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶(LINEãªã©)ã§ã¯å±¥æ­´ãŒä¿å­˜ã•ã‚Œã¾ã›ã‚“ğŸ’¦</p>
                    <div className="bg-gray-100 p-4 rounded-xl text-left mb-4 text-sm text-gray-700">
                        <p className="mb-2 font-bold">ğŸ‘‡ Safari/Chromeã§é–‹ã„ã¦ã­ï¼</p>
                        <ol className="list-decimal list-inside space-y-1">
                            <li>å³ä¸Šã® <span className="font-bold bg-white px-1 rounded border">ï¸™</span> ã‚„ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™</li>
                            <li><span className="font-bold text-blue-600">ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã€</span> ã‚’é¸ã¶</li>
                        </ol>
                    </div>
                    <button onClick={onClose} className="text-xs text-gray-400 underline p-2">åˆ†ã‹ã£ãŸã‘ã©ã“ã®ã¾ã¾ä½¿ã†</button>
                </div>
            </div>
        );

        // --- ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ ã‚¬ã‚¤ãƒ‰ ---
        const InstallGuide = ({ onClose }) => {
            const isIOS = /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
            return (
                <div className="fixed bottom-0 left-0 right-0 p-4 z-50 slide-up pb-safe">
                    <div className="bg-gray-800/95 backdrop-blur text-white rounded-2xl p-4 shadow-2xl relative border border-pink-400">
                        <button onClick={onClose} className="absolute top-2 right-2 text-gray-400 p-2"><Icons.X size={18} /></button>
                        <div className="flex items-start gap-4">
                            <div className="bg-pink-500 p-3 rounded-xl shrink-0"><Icons.Download size={24} /></div>
                            <div>
                                <h3 className="font-bold text-sm mb-1 font-pop">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã‚ˆã†ï¼</h3>
                                <p className="text-xs text-gray-300 mb-2">ã‚¢ãƒ—ãƒªã¿ãŸã„ã«ä½¿ãˆã¦ã€å…¨ç”»é¢ã§è¦‹ã‚„ã™ããªã‚‹ã‚ˆâœ¨</p>
                                <div className="text-xs font-bold text-pink-300 flex items-center gap-1 flex-wrap">
                                    {isIOS ? <><span className="bg-gray-600 px-1 rounded inline-flex"><Icons.IosShare size={12}/></span> ã‹ã‚‰ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</> : <>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ <span className="bg-gray-600 px-1 rounded text-[10px]">ï¸™</span> ã‹ã‚‰ã€Œã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€</>}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ãŠã‹ãˆã‚Šãƒ¢ãƒ¼ãƒ€ãƒ« ---
        const WelcomeModal = ({ isOpen, onClose, onYes }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-3xl p-6 w-full max-w-sm modal-enter text-center shadow-2xl" onClick={e => e.stopPropagation()}>
                        <div className="text-5xl mb-4">ğŸ </div>
                        <h3 className="text-xl font-black text-gray-800 mb-2 font-pop">ãŠã‹ãˆã‚Šãªã•ã„ï¼</h3>
                        <p className="text-gray-600 font-bold mb-6 text-sm">å­¦æ ¡ãƒ»è·å ´ã‹ã‚‰å¸°å®…ã—ãŸï¼Ÿ<br/>ç§»å‹•ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ (-30HP)</p>
                        <div className="flex gap-3">
                            <button onClick={onYes} className="flex-1 bg-pink-500 text-white font-bold py-3 rounded-xl shadow-md active:scale-95">ã¯ã„ï¼(è¨˜éŒ²)</button>
                            <button onClick={onClose} className="flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-xl shadow-md active:scale-95">ã„ã„ãˆ</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ã‚¿ãƒƒãƒ—ãƒœã‚¿ãƒ³ ---
        const ActionButton = ({ icon, color, damage, label, onTrigger }) => {
            const [isCooldown, setIsCooldown] = useState(false);
            const handleClick = () => {
                if (isCooldown) return; 
                onTrigger(); 
                setIsCooldown(true);
                setTimeout(() => { setIsCooldown(false); }, 3000); 
            };
            return (
                <button onClick={handleClick} disabled={isCooldown} className={`relative ${isCooldown ? 'bg-gray-300 scale-95' : color} w-16 h-16 rounded-full shadow-xl flex items-center justify-center text-3xl transition-all duration-300 border-4 border-white active:scale-90`}>
                    {isCooldown ? <div className="w-6 h-6 border-2 border-gray-500 border-t-transparent rounded-full animate-spin"></div> : icon}
                    <span className="absolute -bottom-6 text-[10px] font-bold text-gray-500 whitespace-nowrap bg-white/80 px-1 rounded">{label} -{damage}</span>
                </button>
            );
        };

        // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« ---
        const CalendarModal = ({ isOpen, onClose, history }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            if (!isOpen) return null;
            const historySet = new Set(history);
            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
                const firstDayOfWeek = new Date(year, month, 1).getDay();
                const days = [];
                for (let i = 0; i < firstDayOfWeek; i++) days.push(null);
                for (let i = 1; i <= lastDayOfMonth; i++) days.push(new Date(year, month, i));
                return days;
            };
            const calculateStreakAtDate = (targetDateStr, historySet) => {
                if (!historySet.has(targetDateStr)) return 0;
                let streak = 1;
                let current = new Date(targetDateStr);
                while (true) {
                    current.setDate(current.getDate() - 1);
                    const prevDateStr = getLocalDateStr(current);
                    if (historySet.has(prevDateStr)) streak++; else break;
                }
                return streak;
            };
            const calculateCurrentStreak = (historySet) => {
                const today = getLocalDateStr(new Date());
                const yesterday = getLocalDateStr(new Date(new Date().setDate(new Date().getDate()-1)));
                let start = historySet.has(today) ? today : historySet.has(yesterday) ? yesterday : null;
                return start ? calculateStreakAtDate(start, historySet) : 0;
            };
            const streak = calculateCurrentStreak(historySet);
            const days = getDaysInMonth(currentDate);
            const monthLabel = `${currentDate.getFullYear()}å¹´ ${currentDate.getMonth() + 1}æœˆ`;
            const getStamp = (s) => s >= 30 ? "ğŸŒˆ" : s >= 7 ? "ğŸ’" : s >= 3 ? "ğŸ‘‘" : "ğŸ’®";

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-3xl p-6 w-full max-w-sm modal-enter shadow-2xl relative border-4 border-pink-100" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><Icons.X /></button>
                        <div className="text-center mb-6">
                            <h2 className="text-sm text-gray-500 font-bold mb-1 font-pop">é€£ç¶šè¨˜éŒ²ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼</h2>
                            <div className="text-4xl font-black text-pink-500 font-pop drop-shadow-sm flex items-center justify-center gap-2"><span>{streak}æ—¥</span><span className="animate-pulse">ğŸ”¥</span></div>
                        </div>
                        <div className="flex justify-between items-center mb-2 px-2">
                            <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))} className="p-2 text-pink-400"><Icons.ChevronLeft size={20}/></button>
                            <span className="font-bold text-gray-800 text-lg block">{monthLabel}</span>
                            <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))} className="p-2 text-pink-400"><Icons.ChevronRight size={20}/></button>
                        </div>
                        <div className="calendar-grid mb-2 text-center text-xs font-bold text-gray-400 border-b border-gray-100 pb-2"><div className="text-red-400">æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div className="text-blue-400">åœŸ</div></div>
                        <div className="calendar-grid gap-1">
                            {days.map((date, i) => {
                                if (!date) return <div key={i}></div>;
                                const dateStr = getLocalDateStr(date);
                                const s = calculateStreakAtDate(dateStr, historySet);
                                const isToday = date.toDateString() === new Date().toDateString();
                                const rotate = (date.getDate() * 13) % 20 - 10;
                                return (
                                    <div key={i} className={`calendar-cell ${isToday ? 'bg-pink-50 border border-pink-200' : ''}`}>
                                        <span className={`text-[10px] mb-0.5 ${isToday ? 'text-pink-600 font-bold' : 'text-gray-400'}`}>{date.getDate()}</span>
                                        {s > 0 && <span className="text-2xl absolute bottom-0 stamp-animate select-none" style={{ transform: `rotate(${rotate}deg)` }}>{getStamp(s)}</span>}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // --- B.A.T.H. è¨ºæ–­ãƒ­ã‚¸ãƒƒã‚¯ ---
        const BATH_QUESTIONS = [
            { q: "Q1. ãŠé¢¨å‘‚ã€ã‚·ãƒ£ãƒ¯ãƒ¼ã ã‘ã§æ¸ˆã¾ã›ã¡ã‚ƒã†ï¼Ÿ", opts: [{ l: "åŸºæœ¬ã‚·ãƒ£ãƒ¯ãƒ¼ã®ã¿ (åŠ¹ç‡é‡è¦–)", val: { s: 2 } }, { l: "æ¹¯èˆ¹ã«æµ¸ã‹ã‚ŠãŸã„ (ç™’ã—é‡è¦–)", val: { l: 2 } }] },
            { q: "Q2. ã‚¹ãƒãƒ›ã€æµ´å®¤ã«æŒã¡è¾¼ã‚€ï¼Ÿ", opts: [{ l: "çµ¶å¯¾æŒã¡è¾¼ã‚€ (ã‚¸ãƒƒãƒ—ãƒ­ãƒƒã‚¯å¿…é ˆ)", val: { d: 2 } }, { l: "æŒã¡è¾¼ã¾ãªã„ (ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ‡ãƒˆãƒƒã‚¯ã‚¹)", val: { a: 2 } }] },
            { q: "Q3. å…¥æµ´å‰¤ã¸ã®ã“ã ã‚ã‚Šã¯ï¼Ÿ", opts: [{ l: "è‰²ã€…è©¦ã™ã®ãŒå¥½ã", val: { h: 2 } }, { l: "ç‰¹ã«ãªã„ / ã•ã‚‰æ¹¯", val: { z: 1 } }] },
            { q: "Q4. ãŠé¢¨å‘‚ã§æ­Œã†ï¼Ÿ", opts: [{ l: "ç†±å”±ã™ã‚‹ (ãƒªã‚µã‚¤ã‚¿ãƒ«ä¼šå ´)", val: { l: 1, h: 1 } }, { l: "é™ã‹ã«éã”ã™", val: { s: 1, a: 1 } }] },
            { q: "Q5. é«ªã‚’ä¹¾ã‹ã™ã®ã€ã©ã†æ€ã†ï¼Ÿ", opts: [{ l: "åœ°ç„ã€‚ã‚ã‚“ã©ãã•ã„", val: { z: 3 } }, { l: "ãƒ˜ã‚¢ã‚±ã‚¢å¤§äº‹ã€‚ã¡ã‚ƒã‚“ã¨ã‚„ã‚‹", val: { h: 2 } }] },
            { q: "Q6. ãŠé¢¨å‘‚æƒé™¤ã®é »åº¦ã¯ï¼Ÿ", opts: [{ l: "æ¯æ—¥ã‚„ã‚‹ (ã‚­ãƒ¬ã‚¤å¥½ã)", val: { h: 2 } }, { l: "ãƒŒãƒ¡ãƒªãŒå‡ºãŸã‚‰ã‚„ã‚‹ (é™ç•Œ)", val: { z: 2 } }] },
            { q: "Q7. å…¥æµ´ä¸­ã€ä½•ã—ã¦ã‚‹æ™‚é–“ãŒé•·ã„ï¼Ÿ", opts: [{ l: "å‹•ç”»ãƒ»SNSãƒã‚§ãƒƒã‚¯", val: { d: 3 } }, { l: "ãƒãƒƒã‚µãƒ¼ã‚¸ãƒ»åŠèº«æµ´", val: { h: 2 } }, { l: "ãƒœãƒ¼ãƒƒã¨ã™ã‚‹ãƒ»å¦„æƒ³", val: { a: 2 } }] },
            { q: "Q8. ãŠé¢¨å‘‚ä¸ŠãŒã‚Šã®ä¸€æ¯ã¯ï¼Ÿ", opts: [{ l: "æ°´ãƒ»ãƒãƒ¼ãƒ–ãƒ†ã‚£ãƒ¼ãƒ»ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³", val: { h: 2 } }, { l: "ã‚³ãƒ¼ãƒ’ãƒ¼ç‰›ä¹³ãƒ»ãƒ“ãƒ¼ãƒ«ãƒ»ç‚­é…¸", val: { l: 1, z: 1 } }] },
            { q: "Q9. ãŠé¢¨å‘‚ã«å…¥ã‚‹æ™‚é–“ã¯æ±ºã¾ã£ã¦ã‚‹ï¼Ÿ", opts: [{ l: "å¤œã«ã¡ã‚ƒã‚“ã¨å…¥ã‚‹ (ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³)", val: { n: 2 } }, { l: "æœã‚·ãƒ£ãƒ³æ´¾ / ä¸å®šæœŸ", val: { m: 2 } }] },
            { q: "Q10. æ­£ç›´ã€ãŠé¢¨å‘‚ã¯å¥½ãï¼Ÿ", opts: [{ l: "å¤§å¥½ãï¼å¤©å›½ï¼", val: { l: 3 } }, { l: "ç¾©å‹™ã€‚å…¥ã‚‰ãªãã‚ƒæ­»ã¬ã‹ã‚‰å…¥ã‚‹", val: { s: 2, z: 1 } }] }
        ];

        const calculateBathType = (answers) => {
            let scores = { l:0, s:0, d:0, a:0, h:0, z:0, n:0, m:0 };
            answers.forEach(ans => { Object.keys(ans).forEach(key => scores[key] += ans[key]); });
            const c1 = scores.l >= scores.s ? 'L' : 'S';
            const c2 = scores.d >= scores.a ? 'D' : 'A';
            const c3 = scores.h >= scores.z ? 'H' : 'Z';
            const c4 = scores.n >= scores.m ? 'N' : 'M';
            const code = `${c1}${c2}${c3}${c4}`;
            
            let typeData = { name: "ãƒãƒ©ãƒ³ã‚¹æ¹¯èˆ¹ã‚°ãƒ©ãƒãƒ¼", icon: "ğŸ›", desc: "é©åº¦ã«æ¥½ã—ã¿ã€é©åº¦ã«æŠœãã€‚æ¨™æº–çš„ãªãŠé¢¨å‘‚äººã€‚", friend: "LAHN", enemy: "SDZM" };
            if (code === 'LDHN' || code === 'LAHN') typeData = { name: "ç¾å®¹å®Œç’§ã†ã•ã", icon: "ğŸ°", desc: "ãŠé¢¨å‘‚ï¼ç¾å®¹ã®è–åŸŸã€‚å…¥æµ´å‰¤ã‚‚ãƒ˜ã‚¢ã‚±ã‚¢ã‚‚å®Œç’§ãªãƒ—ãƒ­ã€‚", friend: "SXZM", enemy: "SDZM" };
            if (code === 'LDZN' || code === 'LDZM') typeData = { name: "ã‚¹ãƒãƒ›ä¾å­˜ãƒŠãƒã‚±ãƒ¢ãƒ", icon: "ğŸ¦¥", desc: "ãŠé¢¨å‘‚ã¯å‹•ç”»ã‚’è¦‹ã‚‹å ´æ‰€ã€‚ã®ã¼ã›ã‚‹ã¾ã§å‡ºã‚‰ã‚Œãªã„ã€‚", friend: "SAZN", enemy: "LAHM" };
            if (code === 'SAZN' || code === 'SAZM') typeData = { name: "çˆ†é€Ÿã‚«ãƒ©ã‚¹ã®è¡Œæ°´", icon: "ğŸ¦â€â¬›", desc: "åŠ¹ç‡ã“ãæ­£ç¾©ã€‚å…¥æµ´ã‚¿ã‚¤ãƒ ã¯çŸ­ã‘ã‚Œã°çŸ­ã„ã»ã©è‰¯ã„ã€‚", friend: "LDHN", enemy: "LAHN" };
            if (code === 'SDZN' || code === 'SDZM') typeData = { name: "é™ç•Œãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼ã‚¾ãƒ³ãƒ“", icon: "ğŸ§Ÿâ€â™€ï¸", desc: "ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼ãŒåœ°ç„ã€‚æ°—åˆã ã‘ã§ãŠé¢¨å‘‚ã«å…¥ã£ã¦ã„ã‚‹æˆ¦å£«ã€‚", friend: "LAHN", enemy: "LDHN" };
            if (code === 'LAHM' || code === 'LNHM') typeData = { name: "ãƒ‡ãƒˆãƒƒã‚¯ã‚¹ä»™äºº", icon: "ğŸ§˜â€â™€ï¸", desc: "ã‚¹ãƒãƒ›ã‚’æ¨ã¦ã€æ¹¯ã¨å‘ãåˆã†ã€‚ç²¾ç¥çµ±ä¸€ã®å ´ã¨ã—ã¦ã„ã‚‹ã€‚", friend: "SDZM", enemy: "LDZN" };
            if (code === 'SAHN' || code === 'SAHM') typeData = { name: "æœæ´»ã‚·ãƒ£ãƒ¯ãƒ¼ã‚¢ãƒ©ã‚¤ã‚°ãƒ", icon: "ğŸ¦", desc: "å¤œã‚ˆã‚Šæœæ´¾ã€‚ã‚·ãƒ£ã‚­ãƒƒã¨ç›®è¦šã‚ã‚‹ãŸã‚ã«æ°´ã‚’æµ´ã³ã‚‹ã€‚", friend: "LDZM", enemy: "SDZN" };
            if (code === 'SDHN' || code === 'SDZM') typeData = { name: "ç–²ã‚Œæœã¦ãŸã‚«ãƒ", icon: "ğŸ¦›", desc: "æœ€ä½é™ã—ã‹é ‘å¼µã‚Œãªã„ã€‚æ¹¯èˆ¹ã«ã¯æµ¸ã‹ã‚‹ãŒä»–ã®åŠªåŠ›ã¯ã—ãªã„ã€‚", friend: "LAHN", enemy: "SAZN" };
            return { code, ...typeData };
        };

        const TypeDiagnosisModal = ({ isOpen, onClose, onSetType, initialType, onShare }) => {
            const [step, setStep] = useState(0);
            const [scores, setScores] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [resultData, setResultData] = useState(initialType || null); 
            
            useEffect(() => {
                if (isOpen && initialType) {
                    setResultData(initialType);
                    setStep('result');
                } else if (isOpen && !initialType) {
                    setStep(0);
                    setScores([]);
                    setResultData(null);
                }
            }, [isOpen, initialType]);

            if (!isOpen) return null;

            const handleAnswer = (val) => {
                const newScores = [...scores, val];
                setScores(newScores);
                if (step + 1 < BATH_QUESTIONS.length) {
                    setStep(step + 1);
                } else {
                    setIsLoading(true);
                    setTimeout(() => {
                        const result = calculateBathType(newScores);
                        setResultData(result); 
                        onSetType(result);     
                        setIsLoading(false);
                        setStep('result');
                    }, 1500); 
                }
            };

            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-3xl p-6 w-full max-w-sm modal-enter text-center relative overflow-hidden" onClick={e => e.stopPropagation()}>
                        {isLoading ? (
                            <div className="py-10">
                                <div className="text-4xl animate-spin mb-4">ğŸ›</div>
                                <h3 className="font-bold text-pink-500 font-pop animate-pulse">åˆ†æä¸­...</h3>
                            </div>
                        ) : step === 'result' && resultData ? ( 
                            <>
                                <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><Icons.X /></button>
                                <h3 className="text-sm font-bold text-gray-400 mb-1">B.A.T.H.è¨ºæ–­çµæœ</h3>
                                <div className="text-3xl font-black text-pink-500 font-pop mb-4 tracking-widest">{resultData.code}å‹</div>
                                
                                <div className="bg-gradient-to-br from-pink-50 to-purple-50 border-2 border-pink-200 rounded-2xl p-6 mb-4 relative overflow-hidden">
                                    <div className="absolute -right-4 -top-4 text-8xl opacity-10">{resultData.icon}</div>
                                    <div className="text-6xl mb-2 relative z-10">{resultData.icon}</div>
                                    <h2 className="text-xl font-black text-gray-800 mb-2 font-pop relative z-10">{resultData.name}</h2>
                                    <p className="text-sm text-gray-600 font-bold leading-relaxed relative z-10">{resultData.desc}</p>
                                </div>

                                <div className="grid grid-cols-2 gap-3 mb-6 text-xs font-bold">
                                    <div className="bg-blue-50 p-2 rounded-lg text-blue-600">ç›¸æ€§â—: {resultData.friend}å‹</div>
                                    <div className="bg-red-50 p-2 rounded-lg text-red-500">å¤©æ•µ: {resultData.enemy}å‹</div>
                                </div>

                                <button onClick={() => onShare(resultData)} className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-xl shadow-md active:scale-95 mb-3 flex items-center justify-center gap-2">
                                    <Icons.Share size={20} /> è¨ºæ–­çµæœã‚’ã‚·ã‚§ã‚¢ã™ã‚‹
                                </button>
                                <button onClick={onClose} className="text-xs text-gray-400 underline">é–‰ã˜ã‚‹</button>
                            </>
                        ) : (
                            <>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-lg font-bold text-pink-400 font-pop">B.A.T.H.è¨ºæ–­</h3>
                                    <span className="text-xs font-bold bg-pink-100 text-pink-500 px-2 py-1 rounded-full">{step + 1} / {BATH_QUESTIONS.length}</span>
                                </div>
                                <p className="text-lg font-bold text-gray-800 mb-8 font-hand min-h-[3rem] flex items-center justify-center">{BATH_QUESTIONS[step].q}</p>
                                <div className="space-y-4">
                                    {BATH_QUESTIONS[step].opts.map((opt, i) => (
                                        <button key={i} onClick={() => handleAnswer(opt.val)} className="w-full bg-white border-2 border-pink-100 hover:bg-pink-50 text-gray-700 font-bold py-4 rounded-xl shadow-sm transition-all active:scale-95 text-sm">
                                            {opt.l}
                                        </button>
                                    ))}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [hp, setHp] = useState(100);
            const [lastBathTime, setLastBathTime] = useState(new Date());
            const [eventDamageTotal, setEventDamageTotal] = useState(0);
            const [logs, setLogs] = useState([]);
            const [bathHistory, setBathHistory] = useState([]);
            const [userType, setUserType] = useState(null); 
            
            const [isCalendarOpen, setIsCalendarOpen] = useState(false);
            const [isTypeDiagOpen, setIsTypeDiagOpen] = useState(false);
            const [showWelcomeModal, setShowWelcomeModal] = useState(false);
            const [showInAppWarning, setShowInAppWarning] = useState(false);
            const [showInstallGuide, setShowInstallGuide] = useState(false);
            
            const [isGenerating, setIsGenerating] = useState(false);
            const [generatedImage, setGeneratedImage] = useState(null);

            // åˆæœŸãƒ­ãƒ¼ãƒ‰
            useEffect(() => {
                const load = (k) => localStorage.getItem(k);
                if (load(STORAGE_KEY_HP)) setHp(parseFloat(load(STORAGE_KEY_HP)));
                if (load(STORAGE_KEY_LAST_BATH)) setLastBathTime(new Date(load(STORAGE_KEY_LAST_BATH)));
                if (load(STORAGE_KEY_DAMAGE)) setEventDamageTotal(parseFloat(load(STORAGE_KEY_DAMAGE)));
                if (load(STORAGE_KEY_LOGS)) setLogs(JSON.parse(load(STORAGE_KEY_LOGS)));
                if (load(STORAGE_KEY_HISTORY)) setBathHistory(JSON.parse(load(STORAGE_KEY_HISTORY)));
                if (load(STORAGE_KEY_USER_TYPE)) setUserType(JSON.parse(load(STORAGE_KEY_USER_TYPE)));
                
                // ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶åˆ¤å®š
                const ua = navigator.userAgent.toLowerCase();
                if (/line|instagram|twitter|fbav|fban/.test(ua)) {
                    setShowInAppWarning(true);
                } else {
                    // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«åˆ¤å®š (ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ã§ãªã„å ´åˆ)
                    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
                    if (!isStandalone) setTimeout(() => setShowInstallGuide(true), 2000);
                }

                // ãŠã‹ãˆã‚Šãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¤å®š
                const lastLogin = localStorage.getItem('hq_last_login');
                const now = new Date();
                if (lastLogin) {
                    const diff = (now - new Date(lastLogin)) / (1000 * 60 * 60);
                    if (diff > 6 && diff < 16) {
                        setShowWelcomeModal(true);
                    }
                }
                localStorage.setItem('hq_last_login', now.toISOString());
            }, []);

            // ä¿å­˜
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY_HP, hp.toString());
                localStorage.setItem(STORAGE_KEY_LAST_BATH, lastBathTime.toISOString());
                localStorage.setItem(STORAGE_KEY_DAMAGE, eventDamageTotal.toString());
                localStorage.setItem(STORAGE_KEY_LOGS, JSON.stringify(logs));
                localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(bathHistory));
                if (userType) localStorage.setItem(STORAGE_KEY_USER_TYPE, JSON.stringify(userType));
            }, [hp, lastBathTime, eventDamageTotal, logs, bathHistory, userType]);

            // HPè¨ˆç®—
            const [currentTime, setCurrentTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 5000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                const diffMs = new Date() - lastBathTime;
                const hours = diffMs / (1000 * 60 * 60);
                const timeDamage = hours * BASE_RATE_PER_HOUR; 
                const totalDamage = timeDamage + eventDamageTotal;
                setHp(Math.max(0, Math.min(100, 100 - totalDamage)));
            }, [currentTime, lastBathTime, eventDamageTotal]);

            const addLog = (text, icon) => {
                const timeStr = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                setLogs(prev => [{ time: timeStr, text, icon: icon || "ğŸ“±" }, ...prev].slice(0, 50));
            };

            const handleBath = () => {
                setLastBathTime(new Date());
                setEventDamageTotal(0);
                setHp(100);
                addLog("ãŠé¢¨å‘‚å…¥ã£ã¦å¾©æ´»ï¼ä»Šæ—¥ã‚‚ç§ãŒä¸€ç•ªã‚«ãƒ¯ã‚¤ã‚¤ğŸ’–", "ğŸ›");
                const today = getLocalDateStr(new Date());
                setBathHistory(prev => Array.from(new Set(prev).add(today)));
                if (navigator.vibrate) navigator.vibrate([0, 100, 50, 100]);
            };

            const generateShareImage = async (mode = 'status') => {
                setIsGenerating(true);
                const targetId = mode === 'type' ? 'share-target-type' : 'share-target-status';
                const node = document.getElementById(targetId);
                
                try {
                    await new Promise(r => setTimeout(r, 200));
                    const dataUrl = await htmlToImage.toPng(node, { quality: 1.0, pixelRatio: 3, style: { transform: 'scale(1)' } });
                    setGeneratedImage(dataUrl);
                    
                    if (navigator.canShare && navigator.canShare({ files: [new File([], 't.png')] })) {
                        const blob = await (await fetch(dataUrl)).blob();
                        const file = new File([blob], "checker.png", { type: "image/png" });
                        const shareText = mode === 'type' 
                            ? `ç§ã®å…¥æµ´ã‚¿ã‚¤ãƒ—ã¯ã€${userType?.code}å‹ã€‘ï¼æ€§æ ¼ã¾ã§ãƒãƒ¬ã‚‹ã‹ã‚‚...ï¼ŸğŸ›€ #ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼`
                            : `æ¸…æ½”åº¦${Math.floor(hp)}%ï¼${getStatus(hp).shareMsg} #ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼`;
                        try { await navigator.share({ title: 'ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼', text: shareText, files: [file] }); } catch(e){}
                    }
                } catch (e) { 
                    alert('ç”»åƒç”Ÿæˆå¤±æ•—ğŸ’¦'); 
                    console.error(e);
                } 
                finally { setIsGenerating(false); }
            };

            const getStatus = (hp) => {
                if (hp >= 80) return { avatar: "ğŸ‘¸", label: "å¤§å‹åˆ©", deco: "ğŸ‘‘", shareMsg: "å…¨äººé¡è¦‹ã¦âœ¨", glow: "bg-pink-400" };
                if (hp >= 50) return { avatar: "ğŸ˜", label: "å¤©ä½¿", deco: "âœ¨", shareMsg: "ã¾ã èˆãˆã‚‹ã¯ãš", glow: "bg-yellow-200" };
                if (hp >= 20) return { avatar: "ğŸ˜°", label: "é™ç•Œ", deco: "ğŸ’¦", shareMsg: "åŠå¾„2mæ¥è¿‘ç¦æ­¢", glow: "bg-purple-300" };
                return { avatar: "ğŸ§Ÿâ€â™€ï¸", label: "çµ‚äº†", deco: "ğŸ’€", shareMsg: "ç¤¾ä¼šçš„ã«æ­»ğŸ˜‡", glow: "bg-gray-500" };
            };
            
            const status = getStatus(hp);
            const hoursSince = ((new Date() - lastBathTime) / (1000 * 60 * 60)).toFixed(1);

            return (
                <div className="min-h-screen w-full flex flex-col items-center py-6 px-4 pb-safe relative">
                    <div className="float-bg">{[...Array(15)].map((_,i)=><div key={i} className="float-item" style={{left:`${Math.random()*100}%`, animationDuration:`${15+Math.random()*20}s`, animationDelay:`${Math.random()*10}s`, fontSize:`${10+Math.random()*20}px`}}>{i%3===0?'ğŸ’–':i%3===1?'âœ¨':'ğŸ›'}</div>)}</div>

                    {/* ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ (è­¦å‘Šãƒ»ã‚¬ã‚¤ãƒ‰ãƒ»ãŠã‹ãˆã‚Š) */}
                    {showInAppWarning && <InAppBrowserWarning onClose={() => setShowInAppWarning(false)} />}
                    {showInstallGuide && <InstallGuide onClose={() => setShowInstallGuide(false)} />}
                    <WelcomeModal 
                        isOpen={showWelcomeModal} 
                        onClose={() => setShowWelcomeModal(false)}
                        onYes={() => {
                            setEventDamageTotal(prev => prev + 30);
                            addLog("ãŠã‹ãˆã‚Šè‡ªå‹•è¨˜éŒ² (-30)", "ğŸ ");
                            setShowWelcomeModal(false);
                        }}
                    />

                    {/* Header */}
                    <div className="w-full flex justify-between items-center pt-safe mb-6 mt-2 relative z-20 px-2">
                        <button onClick={() => setIsCalendarOpen(true)} className="bg-white/80 p-3 rounded-full shadow-md text-pink-500 hover:scale-110 transition-transform"><Icons.Calendar size={24} /></button>
                        <h1 className="text-sm font-black text-pink-500 bg-white/90 px-4 py-1.5 rounded-full border-2 border-pink-200 shadow-sm font-pop">ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼</h1>
                        <div className="flex gap-2">
                            <button onClick={() => generateShareImage('status')} disabled={isGenerating} className="bg-white/80 p-3 rounded-full shadow-md text-pink-500 hover:scale-110 transition-transform disabled:opacity-50">{isGenerating ? <div className="animate-spin w-6 h-6 border-2 border-pink-500 border-t-transparent rounded-full"></div> : <Icons.Share size={24} />}</button>
                        </div>
                    </div>

                    {/* Main Card */}
                    <div className="w-full max-w-sm glass-card rounded-3xl p-6 mb-6 text-center relative overflow-visible">
                        <div className="absolute -top-6 right-0 text-6xl animate-bounce z-20 filter drop-shadow-lg pr-4">{status.deco}</div>
                        <div className="absolute top-0 left-0 bg-pink-500 text-white text-xs font-bold px-3 py-1 rounded-br-2xl rounded-tl-2xl shadow-sm z-10 font-pop">{status.label}</div>
                        <div className="w-48 h-48 mx-auto mt-6 mb-6 relative purupuru select-none flex items-center justify-center">
                            <div className={`absolute inset-0 rounded-full opacity-50 blur-xl ${status.glow}`}></div>
                            <div className="relative z-10 text-9xl">{status.avatar}</div>
                        </div>
                        <div className="relative pt-1 mb-2">
                            <div className="flex mb-2 items-center justify-between font-pop">
                                <span className="text-sm font-bold inline-block py-1 px-3 uppercase rounded-full text-white bg-pink-400 shadow-md">ç››ã‚Œåº¦</span>
                                <span className="text-2xl font-black text-pink-500 drop-shadow-sm">{Math.floor(hp)}%</span>
                            </div>
                            <div className="h-6 w-full rounded-full meter-track relative mt-2"><div style={{ width: `${hp}%` }} className="h-full rounded-full meter-fill relative"></div><div style={{ left: `calc(${hp}% - 12px)` }} className="absolute top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center meter-icon"><span className="text-2xl">ğŸ’–</span></div></div>
                        </div>
                        <div className="relative bg-white/80 rounded-xl p-4 border-2 border-pink-100 shadow-sm mt-4">
                            <div className="absolute -top-3 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-white border-t-2 border-l-2 border-pink-100 rotate-45"></div>
                            <p className="font-bold text-gray-700 leading-relaxed text-sm font-hand">{status.shareMsg}</p>
                        </div>
                    </div>

                    <div className="bg-white/80 px-6 py-3 rounded-2xl mb-6 shadow-md border-2 border-white flex items-center justify-between w-full max-w-sm">
                        <div className="flex items-center gap-2 text-pink-400"><Icons.Clock size={20} /><span className="text-xs font-bold">çµŒéæ™‚é–“</span></div>
                        <span className="text-2xl font-black text-pink-500 font-pop">{hoursSince}<span className="text-sm ml-1 text-pink-400">H</span></span>
                    </div>

                    <button onClick={() => setIsTypeDiagOpen(true)} className="w-full max-w-sm bg-white border-2 border-blue-200 text-blue-500 hover:bg-blue-50 font-bold py-3 rounded-2xl shadow-sm mb-4 flex items-center justify-center gap-2 transition-all active:scale-95">
                        <span className="text-xl">ğŸ›</span> <span>{userType ? 'è¨ºæ–­çµæœã‚’è¦‹ã‚‹' : 'B.A.T.H.ã‚¿ã‚¤ãƒ—è¨ºæ–­ã‚’ã™ã‚‹'}</span>
                    </button>

                    <button onClick={handleBath} className="w-full max-w-sm bg-gradient-to-r from-pink-400 to-purple-400 hover:from-pink-500 hover:to-purple-500 text-white font-black py-4 rounded-full shadow-lg border-4 border-white active:scale-95 transition-all mb-8 flex items-center justify-center gap-2 text-lg font-pop">
                        <Icons.Bath size={24} /> <span>ãŠé¢¨å‘‚å…¥ã£ã¦ãƒªã‚»ãƒƒãƒˆâœ¨</span>
                    </button>

                    <div className="w-full max-w-sm bg-white/50 rounded-2xl p-4 h-48 overflow-y-auto border border-white scrollbar-hide">
                        <h3 className="text-xs font-bold text-gray-400 mb-3 pl-1 sticky top-0 bg-transparent font-pop">HISTORY</h3>
                        <div className="space-y-3">
                            {logs.map((log, index) => (
                                <div key={index} className="flex gap-3 animate-fade-in-up">
                                    <div className="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center flex-shrink-0 text-lg border border-pink-200 select-none">{log.icon}</div>
                                    <div className="bg-white p-2 rounded-r-xl rounded-bl-xl text-xs shadow-sm border border-gray-100 flex-1">
                                        <div className="text-gray-400 text-[10px] mb-0.5 font-pop">{log.time}</div>
                                        <div className="text-gray-600 font-hand">{log.text}</div>
                                    </div>
                                </div>
                            ))}
                            {logs.length === 0 && <p className="text-xs text-gray-400 text-center py-4 font-hand">å±¥æ­´ã¯ãªã„ã‚ˆï¼</p>}
                        </div>
                    </div>

                    <div className="fixed bottom-6 left-0 right-0 flex justify-center gap-4 z-40 pointer-events-none">
                        <div className="pointer-events-auto">
                            <ActionButton icon="ğŸ’¦" color="bg-blue-400" damage={30} label="é‹å‹•" onTrigger={()=>{setEventDamageTotal(p=>p+30); addLog("ãƒœã‚¿ãƒ³: é‹å‹•ã—ãŸï¼ (-30)", "ğŸ’¦"); if(navigator.vibrate) navigator.vibrate([50,50]);}} />
                        </div>
                        <div className="pointer-events-auto">
                            <ActionButton icon="ğŸ–" color="bg-orange-400" damage={10} label="é£Ÿäº‹" onTrigger={()=>{setEventDamageTotal(p=>p+10); addLog("ãƒœã‚¿ãƒ³: é£Ÿäº‹ (-10)", "ğŸ–"); if(navigator.vibrate) navigator.vibrate(100);}} />
                        </div>
                        <div className="pointer-events-auto">
                            <ActionButton icon="ğŸ›Œ" color="bg-purple-400" damage={20} label="ç¡çœ " onTrigger={()=>{setEventDamageTotal(p=>p+20); addLog("ãƒœã‚¿ãƒ³: å¯ã¦èµ·ããŸ (-20)", "ğŸ›Œ"); if(navigator.vibrate) navigator.vibrate(50);}} />
                        </div>
                    </div>

                    <CalendarModal isOpen={isCalendarOpen} onClose={() => setIsCalendarOpen(false)} history={bathHistory} />
                    
                    <TypeDiagnosisModal 
                        isOpen={isTypeDiagOpen} 
                        onClose={() => setIsTypeDiagOpen(false)} 
                        onSetType={setUserType} 
                        initialType={userType} 
                        onShare={() => generateShareImage('type')} 
                    />
                    
                    {generatedImage && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6" onClick={() => setGeneratedImage(null)}>
                            <div className="bg-white rounded-3xl p-4 w-full max-w-sm relative" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setGeneratedImage(null)} className="absolute -top-3 -right-3 bg-gray-500 text-white p-2 rounded-full"><Icons.X size={16}/></button>
                                <h3 className="text-center font-bold text-gray-700 mb-2 font-pop">ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜ã—ã¦ã­ï¼</h3>
                                <img src={generatedImage} alt="Share" className="w-full rounded-xl border border-gray-200 shadow-inner" />
                            </div>
                        </div>
                    )}

                    {/* --- æ’®å½±ç”¨éš ã—è¦ç´  (2ç¨®é¡) --- */}
                    <div style={{ position: 'fixed', top: '-9999px', left: '-9999px' }}>
                        
                        {/* 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å…±æœ‰ç”¨ */}
                        <div id="share-target-status" className="w-[375px] h-[600px] bg-[#fdf2f8] p-8 flex flex-col items-center justify-center relative overflow-hidden text-center border-4 border-white">
                            <div className="absolute inset-0 opacity-20" style={{backgroundImage: 'radial-gradient(#fbcfe8 20%, transparent 20%)', backgroundSize: '20px 20px'}}></div>
                            <div className="bg-white/90 px-4 py-2 rounded-full border-2 border-pink-200 shadow-sm mb-4 z-10"><h1 className="text-xl font-black text-pink-500 font-pop">ãŠé¢¨å‘‚ãƒã‚§ãƒƒã‚«ãƒ¼</h1></div>
                            <div className="mb-4 relative z-10 scale-110"><div className="text-8xl filter drop-shadow-xl">{status.avatar}</div><div className="absolute -top-4 -right-4 text-5xl">{status.deco}</div></div>
                            <div className="bg-white/60 p-4 rounded-xl border border-pink-100 mb-4 w-full z-10"><div className="text-xs font-bold text-pink-400 mb-1">ãŠé¢¨å‘‚ã«å…¥ã‚‰ãš...</div><div className="text-5xl font-black text-pink-600 font-pop leading-none">{hoursSince}<span className="text-lg ml-1">æ™‚é–“</span></div></div>
                            <div className="bg-white/80 rounded-2xl p-4 border-2 border-pink-100 shadow-md w-full z-10">
                                <div className="flex justify-between items-end mb-2 border-b border-pink-100 pb-2"><span className="font-bold text-gray-500 text-sm">ç¾åœ¨ã®æ¸…æ½”åº¦</span><span className="font-black text-4xl text-pink-500 font-pop">{Math.floor(hp)}%</span></div>
                                <div className="text-left"><span className={`text-xs font-bold text-white px-2 py-1 rounded ${status.glow}`}>{status.label}</span></div>
                                <p className="mt-3 text-sm font-bold text-gray-700 font-hand leading-relaxed">ã€Œ{status.shareMsg}ã€</p>
                            </div>
                            <div className="mt-6 text-gray-400 text-xs font-bold font-pop flex items-center gap-2 opacity-70"><span>ğŸ› ãŠé¢¨å‘‚å…¥ã£ã¦ç››ã‚Œåº¦UPï¼</span></div>
                        </div>

                        {/* 2. ã‚¿ã‚¤ãƒ—è¨ºæ–­å…±æœ‰ç”¨ */}
                        <div id="share-target-type" className="w-[375px] h-[600px] bg-[#fdf2f8] p-8 flex flex-col items-center justify-center relative overflow-hidden text-center border-4 border-white">
                            <div className="absolute inset-0 opacity-20" style={{backgroundImage: 'radial-gradient(#fbcfe8 20%, transparent 20%)', backgroundSize: '20px 20px'}}></div>
                            <div className="bg-white/90 px-4 py-2 rounded-full border-2 border-pink-200 shadow-sm mb-8 z-10"><h1 className="text-xl font-black text-pink-500 font-pop">B.A.T.H.ã‚¿ã‚¤ãƒ—è¨ºæ–­</h1></div>
                            
                            {userType ? (
                                <>
                                    <div className="text-3xl font-black text-pink-500 font-pop mb-6 tracking-widest">{userType.code}å‹</div>
                                    <div className="bg-gradient-to-br from-pink-50 to-purple-50 border-2 border-pink-200 rounded-3xl p-8 mb-6 relative overflow-hidden w-full shadow-lg">
                                        <div className="text-9xl mb-4 relative z-10">{userType.icon}</div>
                                        <h2 className="text-2xl font-black text-gray-800 mb-3 font-pop relative z-10">{userType.name}</h2>
                                        <p className="text-sm text-gray-600 font-bold leading-relaxed relative z-10">{userType.desc}</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 w-full text-xs font-bold mb-8">
                                        <div className="bg-blue-50 p-3 rounded-xl text-blue-600 border border-blue-100">ç›¸æ€§â—<br/><span className="text-lg">{userType.friend}å‹</span></div>
                                        <div className="bg-red-50 p-3 rounded-xl text-red-500 border border-red-100">å¤©æ•µ<br/><span className="text-lg">{userType.enemy}å‹</span></div>
                                    </div>
                                </>
                            ) : (
                                <div className="text-gray-400">è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                            )}
                            <div className="text-gray-400 text-xs font-bold font-pop flex items-center gap-2 opacity-70"><span>ğŸ› ã‚ãªãŸã‚‚ä»Šã™ãè¨ºæ–­ï¼</span></div>
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>